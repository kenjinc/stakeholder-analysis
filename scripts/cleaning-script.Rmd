---
title: "Cleaning Script"
output: github_document
date: "Last Updated: March 23, 2025"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Package Loading

```{r}
library(ggpubr)
library(ggsignif)
library(maps)
library(pheatmap)
library(RColorBrewer)
library(rnaturalearth)
library(rnaturalearthhires)
library(sf)
library(tidyverse)
library(viridis)
```

## Data Loading 

```{r}
survey_data <- read.csv("/Users/kenjinchang/github/stakeholder-analysis/data/parent-files/survey-data.csv")
extraction_data <- read.csv("/Users/kenjinchang/github/stakeholder-analysis/data/parent-files/extraction-data.csv")
```

## Data Cleaning: Scoping Review

* `study_id`: the unique numeral identifier assigned to each independently eligible study included within our scoping review (1-116).
* `study`: the parenthetical, in-text citation for each independently eligible study's corresponding record of reference. 
* `study_no`: the assigned number specifying the order in which the independently eligible study appears within the corresponding record of reference.
* `study_count`: the total number of independently eligible studies appearing within the corresponding record of reference.
* `doi`: the handle, or digital object identifier (DOI), assigned to each independently eligible study's corresponding record of reference.
* `pub_year`: the calendar year when each independently eligible study's corresponding record of reference was published (2001-2024).
* `pub_title`: the given title for each independently eligible study's corresponding record of reference.
* `pub_journal`: the publishing journal of each independently eligible study's record of reference.
* `university_list`: the complete list of treatment-receiving universities participating in the independently eligible study.
* `university_count`: the total number of treatment-receiving universities participating in the independently eligible study.
* `investigation_cat`: the scale of the independently eligible study's investigation (single-site for study's localized to one treatment-receiving university or multi-site for study's implemented across multiple treatment-receiving universities).
* `nation_list`: a duplicate-allowing list pairing the participating treatment-receiving universities mentioned in each study with the ISO (International Organization for Standardization) countries in which they are located.
* `nation_list_count`: the total number of unique and duplicate ISO countries associated with the participating treatment-receiving universities mentioned in each study.
* `nation_var`: a non-duplicate-allowing list pairing the participating treatment-receiving universities mentioned in each study with the ISO countries in which they are located.
* `nation_var_count`: the total number of unique ISO countries associated with the participating treatment-receiving universities mentioned in each study.
* `us_state_list`: a conditional, duplicate-allowing list pairing the participating treatment-receiving universities mentioned in each study with the U.S. state in which they are located.
* `us_state_list_count`: the total number of unique and duplicate U.S. states associated with the participating treatment-receiving universities mentioned in each study.
* `us_state_var`: a conditional, non-duplicate-allowing list pairing the participating treatment-receiving universities mentioned in each study with the U.S. states in which they are located.
* `us_state_var_count`: the total number of unique U.S. states associated with the participating treatment-receiving universities mentioned in each study. 
* `uk_country_list`: a conditional, duplicate-allowing list pairing the participating treatment-receiving universities mentioned in each study with the U.K. country in which they are located.
* `uk_country_list_count`: the total number of unique and duplicate U.K. countries associated with the participating treatment-receiving universities mentioned each study.
* `uk_country_var`: a conditional, non-duplicate allowing list pairing the participating treatment-receiving universities mentioned in each study with the U.K. countries in which they are located.
* `uk_country_var_count`: the total number of unique U.K. countries associated with the participating treatment-receiving universities mentioned in each study.
* `strategy_list`: a duplicate-allowing list pairing the reported intervention components mentioned in each study with the specific behavioral strategies being leveraged. 
* `approach_cat`: the diagnosed behavioral approach associated with each study, based on the strategies mapping on to each study's reported intervention components.
* `target_list`: a duplicate-allowing list pairing the reported intervention components mentioned in each study with the specific socio-ecological tiers being targeted.
* `breadth_cat`: the diagnosed breadth of change associated each study, based on the socio-ecological tiers mapping on to each study's reported intervention components.
* `design`: the  research design of the included study, as determined by the nature of comparison being made (between, within, or between and within).
* `principal_indicator_list`: a duplicate-allowing list outlining the primary outcome measures being used to document changes to food selection or food service in response to the study's reported intervention. 
* `principal_indicator_list_count`: the total number of unique and duplicate primary outcome measures being
* `principal_indicator_var`:
* `principal_indicator_var_count`:
* `accessory_indicator_list`:
* `accessory_indicator_list_count`:
* `accessory_indicator_var`:
* `accessory_indicator_var_count`:
* `qualifying_indicator_list`:
* `qualifying_indicator_list_count`:
* `qualifying_indicator_var`:
* `qualifying_indicator_var_count`:
* `spillover_monitoring_list`:
* `spillover_monitoring_list_count`:
* `spillover_monitoring_var`:
* `spillover_monitoring_var_count`:
* `intention_behavior_monitoring`:

### Time

```{r}
temporal_frequencies <- extraction_data %>%
  select(pub_year,university_count) %>%
  drop_na() %>%
  mutate(count=case_when(university_count>=1~1)) %>%
  group_by(pub_year) %>%
  summarise(frequency=sum(count)) %>%
  mutate(cumulative_frequency=cumsum(frequency)) %>%
  add_row(pub_year=2000,frequency=0) %>%
  add_row(pub_year=2002,frequency=0) %>%
  add_row(pub_year=2003,frequency=0) %>%
  add_row(pub_year=2004,frequency=0) %>%
  add_row(pub_year=2007,frequency=0) %>%
  add_row(pub_year=2008,frequency=0) %>%
  add_row(pub_year=2010,frequency=0) %>%
  arrange(pub_year) %>%
  mutate(cumulative_frequency=cumsum(frequency)) 
temporal_frequencies
```

```{r}
exponential_fit <- temporal_frequencies %>%
  slice(-1)
exponential_model <- lm(log(cumulative_frequency)~pub_year,data=exponential_fit)
summary(exponential_model)
```

```{r}
temporal_frequencies_plot <- temporal_frequencies %>%
  ggplot(aes(x=pub_year,y=frequency,fill=frequency)) + 
  geom_col(color="black",size=0.2) + 
  scale_fill_gradient(name="Count",low="lavender",high="lightslateblue",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  xlab("Publication Year") + 
  ylab("Frequency") + 
  scale_y_continuous(limits=c(0,120),breaks=c(0,29,58,87,116)) +
  scale_x_continuous(breaks=c(2000,2004,2008,2012,2016,2020,2024),limits=c(2000,2025)) +
  labs(caption="   ") + 
  theme(legend.position="none",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
temporal_cumulative_frequencies_plot <- temporal_frequencies %>%
  ggplot(aes(x=pub_year,y=cumulative_frequency,fill=cumulative_frequency)) +
  scale_fill_gradient(name="Count",low="lavender",high="lightslateblue",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  geom_col(color="black",size=0.2) + 
  xlab("Publication Year") + 
  ylab("Cumulative Frequency") + 
  scale_y_continuous(limits=c(0,120),breaks=c(0,29,58,87,116)) +
  scale_x_continuous(breaks=c(2000,2004,2008,2012,2016,2020,2024),limits=c(2000,2025)) +
  labs(caption="Adjusted R-Squared: 0.985 (3sf); p-value < 0.001") + 
  theme(legend.title.position="none",legend.position="none",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.width=unit(50,"pt"),legend.key.height=unit(7.5,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
temporal_plots <- ggarrange(temporal_frequencies_plot,temporal_cumulative_frequencies_plot,
          nrow=2,
          labels=c("A","B"))
ggsave(filename="publication-rate.png",plot=temporal_plots,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=25,height=20,units="cm",dpi=150,limitsize=TRUE)
temporal_plots
```

### Place

```{r}
global_shapefile <- map_data("world")
global_shapefile <- global_shapefile %>% 
  rename(country=region) %>%
  mutate(country=case_when(country=="Macedonia"~"North Macedonia",
                           country=="Ivory Coast"~"Cote d'Ivoire",
                           country=="Democratic Republic of the Congo"~"Congo, Dem. Rep.",
                           country=="Republic of Congo"~"Congo, Rep.",
                           country=="UK"~"United Kingdom",
                           country=="USA"~"United States",
                           country=="Laos"~"Lao",
                           country=="Slovakia"~"Slovak Republic",
                           country=="Saint Lucia"~"St. Lucia",
                           country=="Kyrgyzstan"~"Krygyz Republic",
                           country=="Micronesia"~"Micronesia, Fed. Sts.",
                           country=="Swaziland"~"Eswatini",
                           country=="Virgin Islands"~"Virgin Islands (U.S.)",
                        TRUE~country))
island_nations <- c("Antigua","Barbuda","Nevis", 
                 "Saint Kitts","Trinidad",
                 "Tobago","Grenadines","Saint Vincent")
island_nations_match <- global_shapefile %>% 
  filter(country %in% island_nations)
ant_bar <- c(137,138 )
kit_nev <- c(930,931)
tri_tog <- c(1425,1426)
vin_gre <- c(1575,1576,1577)
island_nation_names <- c("Antigua and Barbuda","St. Kitts and Nevis","Trinidad and Tobago","St. Vincent and the Grenadines")
island_nations_match <- island_nations_match %>% 
  mutate(country=case_when(group %in% ant_bar~"Antigua and Barbuda",
                           group %in% kit_nev~"St. Kitts and Nevis",
                           group %in% tri_tog~"Trinidad and Tobago",
                           group %in% vin_gre~"St. Vincent and the Grenadines")) %>% 
  tibble()
global_shapefile <- global_shapefile %>%
  filter(!country %in% island_nation_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(island_nations_match) %>%
  arrange(country) %>%
  tibble()
sra_names <- c("Hong Kong","Macao")
hk_mc <- global_shapefile %>% 
  filter(subregion %in% sra_names)
hk_mc <- hk_mc %>%
  mutate(country = case_when(subregion=="Hong Kong"~"Hong Kong, China",
                             subregion=="Macao"~"Macao, China"))
global_shapefile <- global_shapefile %>%
  filter(!subregion %in% sra_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(hk_mc) %>%
  select(-subregion) %>% 
  tibble()
```

```{r}
spatial_frequencies <- extraction_data %>%
  select(nation_var,nation_var_count) %>%
  rename(country=nation_var) %>%
  mutate(across(country,str_replace,"USA","United States")) %>%
  mutate(across(country,str_replace,"UK","United Kingdom")) %>%
  group_by(country) %>%
  summarise(frequency=sum(nation_var_count)) %>%
  arrange(desc(frequency))
spatial_frequencies
```

```{r}
spatial_frequencies %>%
  summarise(sum(frequency))
```
scale_fill_gradient(low='white', high='grey20', limits=c(1, 10))

scale_fill_gradient(low="lavender",high="slateblue4",na.value="white",name="Intervention-Receiving Institutions",guide=guide_colourbar(reverse=FALSE,title.position="top",title.hjust=0.5,limits=c(1,116))) +

```{r}
crs_robin <- "+proj=robin +lat_0=0 +lon_0=0 +x0=0 +y0=0"
```


```{r}
spatial_frequencies_joined <- left_join(global_shapefile,spatial_frequencies,by="country")
national_frequencies <- spatial_frequencies_joined %>%
  ggplot(aes(x=long,y=lat,fill=frequency,group=group)) + 
  geom_polygon(color="black",linewidth=0.1) +
  scale_fill_gradient(low="lavender",high="lightslateblue",na.value="white",limits=c(0,55),breaks=c(0,11,22,33,44,55)) +
  coord_sf(crs=crs_robin) +
  xlab("") + 
  ylab("") +
  scale_y_continuous(limits=c(-55,85)) +
  labs(fill="Frequency") +
  theme(aspect.ratio=.48,legend.position="bottom",legend.title.position="top",legend.box.spacing=unit(-10,"pt"),legend.key.width=unit(100,"pt"),legend.key.height=unit(5,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
usa_shapefile <- map_data("county") %>%
  rename(state=region)
```

```{r}
state_frequencies <- extraction_data %>%
  select(study,us_state_var) %>%
  separate_longer_delim(c(us_state_var),delim=";") %>%
  add_column(count=1) %>%
  group_by(us_state_var) %>%
  summarise(frequency=sum(count)) %>%
  arrange(desc(frequency)) %>%
  mutate(us_state_var=tolower(us_state_var)) %>%
  rename(state=us_state_var) %>%
  drop_na()
state_frequencies 
```

```{r}
state_frequencies %>% summarise(sum(frequency))
```

```{r}
state_frequencies_joined <- left_join(usa_shapefile,state_frequencies,by="state")
```

```{r}
usa_frequencies <- state_frequencies_joined %>%
  ggplot(aes(x=long,y=lat,fill=frequency,group=group)) + 
  geom_polygon(color="black",linewidth=0.1) +
  scale_fill_gradient(low="lavender",high="lightslateblue",na.value="white",limits=c(1,55)) +
  xlab("") + 
  ylab("") +
  labs(caption="") +
  coord_map("albers",lat0=45.5,lat1=29.5) +
  theme(legend.key.width=unit(3,"lines"),legend.position="none",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
subnational_frequencies <- extraction_data %>%
  select(uk_country_var,uk_country_var_count) %>%
  rename(subregion=uk_country_var) %>%
  separate_longer_delim(c(subregion,uk_country_var_count),delim=";") %>%
  mutate(uk_country_var_count=as.numeric(uk_country_var_count)) %>%
  group_by(subregion) %>%
  summarise(frequency=sum(uk_country_var_count)) %>%
  arrange(desc(frequency)) %>%
  mutate(across("subregion",str_replace,"England","Great Britain")) %>%
  drop_na()
subnational_frequencies
```

```{r}
uk_shapefile <- ne_states(country="united kingdom",returnclass="sf")
```

```{r}
subnational_frequencies <- subnational_frequencies %>%
  mutate(across('subregion',str_replace,"Great Britain","England")) %>%
  rename(geonunit=subregion)
subnational_frequencies
```

```{r}
subnational_frequencies_joined <- left_join(uk_shapefile,subnational_frequencies,by="geonunit")
```

```{r}
uk_frequencies <- subnational_frequencies_joined %>%
ggplot(aes(fill=frequency,group=geonunit)) + 
  geom_sf(aes(fill=frequency),color="black",linewidth=0.1) +
  scale_fill_gradient(low="lavender",high="lightslateblue",na.value="white",limits=c(1,55)) +
  theme(legend.key.width=unit(3,"lines"),legend.position="none",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
subnational_frequency_choros <- ggarrange(usa_frequencies,uk_frequencies,
                                         ncol=2,
                                         labels=c("B","C"))
national_frequency_choros <- ggarrange(national_frequencies,
                                       labels="A")
```


```{r}
spatial_plots <- ggarrange(national_frequency_choros,subnational_frequency_choros,
          nrow=2)
ggsave(filename="publication-distribution.png",plot=spatial_plots,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=30,height=32,units="cm",dpi=150,limitsize=TRUE)
spatial_plots
```

### Primary Performance Indicators

```{r}
ppi_frequencies <- extraction_data %>%
  select(study,principal_indicator_var) %>%
  separate_longer_delim(c(principal_indicator_var),delim=";") %>%
  add_column(count=1) %>%
  group_by(principal_indicator_var) %>%
  summarise(frequency=sum(count)) %>%
  mutate(across(principal_indicator_var,str_replace_all,"Observed Food Choice","Food Choice, Observed")) %>%
  mutate(across(principal_indicator_var,str_replace_all,"Observed Food Service","Food Service, Observed")) %>%
  mutate(across(principal_indicator_var,str_replace_all,"Self-Reported Food Choice","Food Choice, Self-Reported")) %>%
  mutate(across(principal_indicator_var,str_replace_all,"Intended Food Choice","Food Choice, Intended")) 
ppi_frequencies 
```

```{r}
extraction_data %>% select(study_id,accessory_indicator_var_count) %>%
  group_by(accessory_indicator_var_count) %>%
  summarise(count=n())
```


```{r}
principal_indicator_var_manual <- c("Food Choice, Intended","Food Choice, Self-Reported","Food Choice, Observed","Food Service, Observed")
frequency_manual <- c(36,67,54,2)
ppi_frequencies_manual <- tibble(principal_indicator_var_manual,frequency_manual) %>%
  arrange(desc(frequency_manual))
ppi_frequencies_manual 
```

```{r}
ppi_contingency_table <- ppi_frequencies_manual %>%
  rename(Reported=frequency_manual) %>%
  mutate(Omitted=116-Reported)
ppi_contingency_table
```

```{r}
ppi_contigency_table <- as.table(rbind(c(67,54,36,2),c(49,62,80,114)))
dimnames(ppi_contigency_table) <- list(dichotomy=c("Reported","Omitted"),
                                       indicators=c("Food Choice, Self-Reported","Food Choice, Observed","Food Choice, Intended","Food Service, Observed"))
ppi_chisq_test <- chisq.test(ppi_contigency_table)
ppi_chisq_test
```
Significant associated between the type of principal performance indicator and its likelihood of appearance

```{r}
ppi_observed_counts <- ppi_chisq_test$observed
print(ppi_chisq_test)
```

```{r}
ppi_expected_counts <- ppi_chisq_test$expected
print(round(ppi_expected_counts,2))
```

```{r}
ppi_pearson_residuals <- ppi_chisq_test$residuals
print(round(ppi_pearson_residuals,2))
```

```{r}
ppi_contributions <- (ppi_observed_counts-ppi_expected_counts)^2/ppi_expected_counts
ppi_total_chi_square <- ppi_chisq_test$statistic
ppi_percentage_contributions <- 100*ppi_contributions/ppi_total_chi_square
print("Percentage Contributions:")
```

```{r}
print(round(ppi_percentage_contributions,2))
```

```{r}
pheatmap(ppi_percentage_contributions,display_numbers=TRUE,cluster_rows=FALSE,cluster_cols=FALSE,main="Percentage Contributions to Chi-Square Statistic")
```


```{r}
ppi_contingency_table_alt <- ppi_contingency_table %>%
  pivot_longer(!principal_indicator_var_manual,names_to="appearance",values_to="frequency_manual") %>%
  mutate(contribution=case_when(principal_indicator_var_manual=="Food Choice, Self-Reported"&appearance=="Reported"~20.47,
    principal_indicator_var_manual=="Food Choice, Self-Reported"&appearance=="Omitted"~10.67,
    principal_indicator_var_manual=="Food Choice, Observed"&appearance=="Reported"~5.60,
    principal_indicator_var_manual=="Food Choice, Observed"&appearance=="Omitted"~2.92,
    principal_indicator_var_manual=="Food Choice, Intended"&appearance=="Reported"~0.39,
    principal_indicator_var_manual=="Food Choice, Intended"&appearance=="Omitted"~0.20,
    principal_indicator_var_manual=="Food Service, Observed"&appearance=="Reported"~39.28,
    principal_indicator_var_manual=="Food Service, Observed"&appearance=="Omitted"~20.48)) %>%
  mutate(label_y=case_when(appearance=="Reported"~118,
                           appearance=="Omitted"~-2))
ppi_contingency_table_alt
```

```{r}
ppi_frequencies_plot <- ppi_contingency_table_alt %>%
  ggplot(aes(x=principal_indicator_var_manual,y=frequency_manual,fill=appearance,color=appearance)) + 
  geom_col(color="black",size=0.2) + 
  geom_text(aes(y=label_y,label=paste(format(contribution,nsmall=2),"%")),color="black",size=3) +
  geom_signif(comparisons=list(c("Food Choice, Self-Reported","Food Service, Observed")),color="black",size=0.25,annotation="***",y_position=116,tip_length=0.02,vjust=0) +
  xlab("Principal Indicator") +
  ylab("Frequency") +
  scale_x_discrete(limits=c("Food Service, Observed","Food Choice, Intended","Food Choice, Observed","Food Choice, Self-Reported")) + 
  scale_y_continuous(breaks=c(0,29,58,87,116)) +
  scale_fill_manual(values=c("lavender","lightslateblue")) +
  scale_color_manual(values=c("lavender","lightslateblue")) +
  guides(fill=guide_legend(title="Mode"),color=guide_legend(title="Mode")) +
  labs(caption="X-squared: 91.3 (3sf); p-value < 0.001") + 
  theme(aspect.ratio=0.8,legend.position="right",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

### Accessory Performance Indicators

```{r}
api_frequencies <- extraction_data %>%
  select(study,accessory_indicator_var) %>%
  separate_longer_delim(c(accessory_indicator_var),delim=";") %>%
  add_column(count=1) %>%
  group_by(accessory_indicator_var) %>%
  summarise(frequency=sum(count))
api_frequencies
```

```{r}
accessory_indicator_var_manual <- c("Campus Culture","Dietary Health","Food Pricing","Guest Dining Experience","Institutional Sustainability","Operating Costs","Staff Satisfaction","Sustainability of Guest Food Choices")
frequency_manual <- c(82,27,4,5,2,14,1,13)
api_frequencies_manual <- tibble(accessory_indicator_var_manual,frequency_manual) %>%
  arrange(desc(frequency_manual))
api_frequencies_manual 
```

```{r}
api_contigency_table <- api_frequencies_manual %>%
  rename(Reported=frequency_manual) %>%
  mutate(Omitted=116-Reported)
api_contigency_table
```

```{r}
api_contigency_table_alt <- api_contigency_table %>%
  pivot_longer(!accessory_indicator_var_manual,names_to="appearance",values_to="frequency_manual") %>%
  mutate(contribution=case_when(accessory_indicator_var_manual=="Campus Culture"&appearance=="Reported"~62.97,
    accessory_indicator_var_manual=="Campus Culture"&appearance=="Omitted"~13.71,
    accessory_indicator_var_manual=="Dietary Health"&appearance=="Reported"~0.66,
    accessory_indicator_var_manual=="Dietary Health"&appearance=="Omitted"~0.14,
    accessory_indicator_var_manual=="Operating Costs"&appearance=="Reported"~0.76,
    accessory_indicator_var_manual=="Operating Costs"&appearance=="Omitted"~0.17,
    accessory_indicator_var_manual=="Sustainability of Guest Food Choices"&appearance=="Reported"~1.00,
    accessory_indicator_var_manual=="Sustainability of Guest Food Choices"&appearance=="Omitted"~0.22,
    accessory_indicator_var_manual=="Guest Dining Experience"&appearance=="Reported"~4.15,
    accessory_indicator_var_manual=="Guest Dining Experience"&appearance=="Omitted"~0.90,
    accessory_indicator_var_manual=="Food Pricing"&appearance=="Reported"~0.16,
    accessory_indicator_var_manual=="Food Pricing"&appearance=="Omitted"~0.03,
    accessory_indicator_var_manual=="Institutional Sustainability"&appearance=="Reported"~5.89,
    accessory_indicator_var_manual=="Institutional Sustainability"&appearance=="Omitted"~1.28,
    accessory_indicator_var_manual=="Staff Satisfaction"&appearance=="Reported"~6.53,
    accessory_indicator_var_manual=="Staff Satisfaction"&appearance=="Omitted"~1.42)) %>%
  mutate(label_y=case_when(appearance=="Reported"~118,
                           appearance=="Omitted"~-2))
api_contigency_table_alt
```

```{r}
api_frequencies_plot <- api_contigency_table_alt %>%
  ggplot(aes(x=accessory_indicator_var_manual,y=frequency_manual,fill=appearance,color=appearance)) + 
  geom_col(color="black",size=0.2) + 
  geom_text(aes(y=label_y,label=paste(format(contribution,nsmall=2),"%")),color="black",size=3) +
  geom_signif(comparisons=list(c("Campus Culture","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=116,tip_length=0.02,vjust=0) +
  xlab("Accessory Indicator") +
  ylab("Frequency") +
  scale_x_discrete(limits=c("Staff Satisfaction","Institutional Sustainability","Food Pricing","Guest Dining Experience","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Campus Culture")) + 
  scale_y_continuous(breaks=c(0,29,58,87,116)) +
  scale_fill_manual(values=c("aliceblue","lightsteelblue")) +
  scale_color_manual(values=c("aliceblue","lightsteelblue")) +
  guides(fill=guide_legend(title="Mode"),color=guide_legend(title="Mode")) +
  labs(caption="X-squared: 287 (3sf); p-value < 0.001") + 
  theme(aspect.ratio=0.4,legend.position="right",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
api_contigency_table <- as.table(rbind(c(82,27,14,13,5,4,2,1),c(34,89,102,103,111,12,114,115)))
dimnames(api_contigency_table) <- list(dichotomy=c("Reported","Omitted"),
                                       indicators=c("Campus Culture","Dietary Health","Operating Costs","Sustainability of Guest Food Choices","Guest Dining Experience","Food Pricing","Institutional Sustainability","Staff Satisfaction"))
api_chisq_test <- chisq.test(api_contigency_table)
api_chisq_test
```

Significant association between the type of accessory performance indicator and its likelihood of appearance (chi-square test interpretation (https://www.datacamp.com/tutorial/chi-square-test-r))

```{r}
api_observed_counts <- api_chisq_test$observed
print(api_chisq_test)
```
```{r}
api_expected_counts <- api_chisq_test$expected
print(round(api_expected_counts,2))
```
```{r}
api_pearson_residuals <- api_chisq_test$residuals
print(round(api_pearson_residuals,2))
```
```{r}
api_contributions <- (api_observed_counts-api_expected_counts)^2/api_expected_counts
api_total_chi_square <- api_chisq_test$statistic
api_percentage_contributions <- 100*api_contributions/api_total_chi_square
print("Percentage Contributions:")
print(round(api_percentage_contributions,2))
```

```{r}
library(pheatmap)
pheatmap(api_percentage_contributions,display_numbers=TRUE,cluster_rows=FALSE,cluster_cols=FALSE,main="Percentage Contributions to Chi-Square Statistic")
```

Rerun this using list class instead of variety class

list

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Campus Culture")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Dietary Health")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Operating Costs")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Sustainability of Guest Food Choices")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Guest Dining Experience")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Food Pricing")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Institutional Sustainability")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Staff Satisfaction")
```

### Performance Qualifiers 

```{r}
qpi_frequencies <- extraction_data %>%
  select(study,qualifying_indicator_var) %>%
  separate_longer_delim(c(qualifying_indicator_var),delim=";") %>%
  add_column(count=1) %>%
  group_by(qualifying_indicator_var) %>%
  summarise(frequency=sum(count))
qpi_frequencies
```

```{r}
qualifying_indicator_var_manual <- c("Demographics","Lifestyle","Program Reception","Situational")
frequency_manual <- c(87,46,39,29)
qpi_frequencies_manual <- tibble(qualifying_indicator_var_manual,frequency_manual) %>%
  arrange(desc(frequency_manual))
qpi_frequencies_manual 
```

```{r}
qpi_contingency_table <- qpi_frequencies_manual %>%
  rename(Reported=frequency_manual) %>%
  mutate(Omitted=116-Reported)
qpi_contingency_table
```


```{r}
qpi_contingency_table_alt <- qpi_contingency_table %>%
  pivot_longer(!qualifying_indicator_var_manual,names_to="appearance",values_to="frequency_manual") %>%
  mutate(contribution=case_when(qualifying_indicator_var_manual=="Demographics"&appearance=="Reported"~39.32,
    qualifying_indicator_var_manual=="Demographics"&appearance=="Omitted"~30.05,
    qualifying_indicator_var_manual=="Lifestyle"&appearance=="Reported"~0.53,
    qualifying_indicator_var_manual=="Lifestyle"&appearance=="Omitted"~0.40,
    qualifying_indicator_var_manual=="Program Reception"&appearance=="Reported"~3.68,
    qualifying_indicator_var_manual=="Program Reception"&appearance=="Omitted"~2.82,
    qualifying_indicator_var_manual=="Situational"&appearance=="Reported"~13.15,
    qualifying_indicator_var_manual=="Situational"&appearance=="Omitted"~10.05)) %>%
  mutate(label_y=case_when(appearance=="Reported"~118,
                           appearance=="Omitted"~-2))
api_contigency_table_alt
```

```{r}
qpi_frequencies_plot <- qpi_contingency_table_alt %>%
  ggplot(aes(x=qualifying_indicator_var_manual,y=frequency_manual,fill=appearance,color=appearance)) + 
  geom_col(color="black",size=0.2) + 
  geom_text(aes(y=label_y,label=paste(format(contribution,nsmall=2),"%")),color="black",size=3) +
  geom_signif(comparisons=list(c("Demographics","Situational")),color="black",size=0.25,annotation="***",y_position=116,tip_length=0.02,vjust=0) +
  xlab("Qualifying Indicator") +
  ylab("Frequency") +
  scale_x_discrete(limits=c("Situational","Program Reception","Lifestyle","Demographics")) + 
  scale_y_continuous(breaks=c(0,29,58,87,116)) +
  scale_fill_manual(values=c("mistyrose","lightcoral")) +
  scale_color_manual(values=c("mistyrose","lightcoral")) +
  guides(fill=guide_legend(title="Mode"),color=guide_legend(title="Mode")) +
  labs(caption="X-squared: 68.35 (2dp); p-value < 0.001") + 
  theme(aspect.ratio=0.8,legend.position="right",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
qpi_contingency_table <- as.table(rbind(c(87,46,39,29),c(29,70,77,87)))
dimnames(qpi_contingency_table) <- list(dichomoty=c("Reported","Omitted"),
                                        indicators=c("Demographics","Lifestyle","Program Reception","Situational"))
qpi_chisq_test <- chisq.test(qpi_contingency_table)
qpi_chisq_test
```
Significant association between the type of qualifying performance indicator and its likelihood of appearance

```{r}
qpi_observed_counts <- qpi_chisq_test$observed
print(qpi_chisq_test)
```
```{r}
qpi_expected_counts <- qpi_chisq_test$expected
print(round(qpi_expected_counts,2))
```

```{r}
qpi_pearson_residuals <- qpi_chisq_test$residuals
print(round(qpi_pearson_residuals,2))
```
```{r}
qpi_contributions <- (qpi_observed_counts-qpi_expected_counts)^2/qpi_expected_counts
qpi_total_chi_square <- qpi_chisq_test$statistic
qpi_percentage_contributions <- 100*qpi_contributions/qpi_total_chi_square
print("Percentage Contributions:")
```

```{r}
print(round(qpi_percentage_contributions,2))
```

```{r}
pheatmap(qpi_percentage_contributions,display_numbers=TRUE,cluster_rows=FALSE,cluster_cols=FALSE,main="Percentage Contributions to Chi-Square Statistic")
```

```{r}
principal_qualifying_indicator_plots <- ggarrange(ppi_frequencies_plot,qpi_frequencies_plot,
          ncol=2,
          labels=c("A","C"))
accessory_indicator_plots <- ggarrange(api_frequencies_plot,
          labels="B")
```

```{r}
combined_indicators <- ggarrange(principal_qualifying_indicator_plots,accessory_indicator_plots,
          nrow=2)
ggsave(filename="combined-performance-indicators.png",plot=combined_indicators,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=45,height=33,units="cm",dpi=150,limitsize=TRUE)
combined_indicators
```

### Gap Monitoring

#### Spillover 

#### Intention-Behavior Asymmetries

## Data Cleaning: Stakeholder Analysis

* `date`: the 
* `completion`: the 
* `channel`: the 
* `consent`: the 
* `involvement`: the 
* `involvement_other`: the 
* `stakeholder_type`: the 
* `stakeholder_type_other`: the 
* `role_title`: the 
* `role_duration``: the 
* `dietary_health_ranking`: the 
* `dietary_sustainability_ranking`: the 
* `institutional_sustainability_ranking`: the 
* `food_pricing_ranking`: the 
* `operating_costs_ranking`: the 
* `guest_experience_ranking`: the 
* `staff_satisfaction_ranking`: the 
* `campus_culture_ranking`: the 
* `other_ranking`: the 
* `other_ranking_other`: the 

```{r}
survey_data <- survey_data %>%
  select(RecordedDate,Progress,DistributionChannel,Q1,Q2,Q2_4_TEXT,Q6,Q6_10_TEXT,Q3,Q5_1,Q2_1,Q2_2,Q2_3,Q2_4,Q2_5,Q2_6,Q2_7,Q2_8,Q2_9,Q2_9_TEXT) %>%
  rename(date=RecordedDate,completion=Progress,mode=DistributionChannel,consent=Q1,role=Q2,role_other=Q2_4_TEXT,stakeholder_type=Q6,stakeholder_type_other=Q6_10_TEXT,position_title=Q3,position_duration=Q5_1,dietary_health_ranking=Q2_1,dietary_sustainability_ranking=Q2_2,institutional_sustainability_ranking=Q2_3,food_pricing_ranking=Q2_4,operating_costs_ranking=Q2_5,guest_experience_ranking=Q2_6,staff_satisfaction_ranking=Q2_7,campus_culture_ranking=Q2_8,other_ranking=Q2_9,other_ranking_other=Q2_9_TEXT) %>%
  slice(3:n()) %>%
  mutate(dietary_health_ranking=as.numeric(dietary_health_ranking)) %>%
  mutate(dietary_sustainability_ranking=as.numeric(dietary_sustainability_ranking)) %>%
  mutate(institutional_sustainability_ranking=as.numeric(institutional_sustainability_ranking)) %>%
  mutate(food_pricing_ranking=as.numeric(food_pricing_ranking)) %>%
  mutate(operating_costs_ranking=as.numeric(operating_costs_ranking)) %>%
  mutate(guest_experience_ranking=as.numeric(guest_experience_ranking)) %>%
  mutate(staff_satisfaction_ranking=as.numeric(staff_satisfaction_ranking)) %>%
  mutate(campus_culture_ranking=as.numeric(campus_culture_ranking)) %>%
  mutate(other_ranking=as.numeric(other_ranking)) %>%
  mutate(id=row_number(),.before=role) %>%
  mutate(campus_culture_ranking=case_when(id==22~8,TRUE~campus_culture_ranking)) %>%
  mutate(staff_satisfaction_ranking=case_when(id==22~7,TRUE~staff_satisfaction_ranking)) %>%
  mutate(operating_costs_ranking=case_when(id==22~2,TRUE~operating_costs_ranking)) %>%
  mutate(food_pricing_ranking=case_when(id==22~3,TRUE~food_pricing_ranking)) %>%
  mutate(institutional_sustainability_ranking=case_when(id==22~4,TRUE~institutional_sustainability_ranking)) %>%
  mutate(dietary_sustainability_ranking=case_when(id==22~5,TRUE~dietary_sustainability_ranking)) %>%
  mutate(dietary_health_ranking=case_when(id==22~6,TRUE~dietary_health_ranking)) %>%
  select(-other_ranking,-other_ranking_other,-completion,-date,-mode,-consent) %>%
  mutate(dietary_health_score=case_when(dietary_health_ranking==1~8,
                                        dietary_health_ranking==2~7,
                                        dietary_health_ranking==3~6,
                                        dietary_health_ranking==4~5,
                                        dietary_health_ranking==5~4,
                                        dietary_health_ranking==6~3,
                                        dietary_health_ranking==7~2,
                                        dietary_health_ranking==8~1)) %>%
  mutate(dietary_sustainability_score=case_when(dietary_sustainability_ranking==1~8,
                                                dietary_sustainability_ranking==2~7,
                                                dietary_sustainability_ranking==3~6,
                                                dietary_sustainability_ranking==4~5,
                                                dietary_sustainability_ranking==5~4,
                                                dietary_sustainability_ranking==6~3,
                                                dietary_sustainability_ranking==7~2,
                                                dietary_sustainability_ranking==8~1)) %>%
  mutate(institutional_sustainability_score=case_when(institutional_sustainability_ranking==1~8,
                                                      institutional_sustainability_ranking==2~7,
                                                      institutional_sustainability_ranking==3~6,
                                                      institutional_sustainability_ranking==4~5,
                                                      institutional_sustainability_ranking==5~4,
                                                      institutional_sustainability_ranking==6~3,
                                                      institutional_sustainability_ranking==7~2,
                                                      institutional_sustainability_ranking==8~1)) %>%
  mutate(food_pricing_score=case_when(food_pricing_ranking==1~8,
                                      food_pricing_ranking==2~7,
                                      food_pricing_ranking==3~6,
                                      food_pricing_ranking==4~5,
                                      food_pricing_ranking==5~4,
                                      food_pricing_ranking==6~3,
                                      food_pricing_ranking==7~2,
                                      food_pricing_ranking==8~1)) %>%
  mutate(operating_costs_score=case_when(operating_costs_ranking==1~8,
                                         operating_costs_ranking==2~7,
                                         operating_costs_ranking==3~6,
                                         operating_costs_ranking==4~5,
                                         operating_costs_ranking==5~4,
                                         operating_costs_ranking==6~3,
                                         operating_costs_ranking==7~2,
                                         operating_costs_ranking==8~1)) %>%
  mutate(guest_experience_score=case_when(guest_experience_ranking==1~8,
                                          guest_experience_ranking==2~7,
                                          guest_experience_ranking==3~6,
                                          guest_experience_ranking==4~5,
                                          guest_experience_ranking==5~4,
                                          guest_experience_ranking==6~3,
                                          guest_experience_ranking==7~2,
                                          guest_experience_ranking==8~1)) %>%
  mutate(staff_satisfaction_score=case_when(staff_satisfaction_ranking==1~8,
                                            staff_satisfaction_ranking==2~7,
                                            staff_satisfaction_ranking==3~6,
                                            staff_satisfaction_ranking==4~5,
                                            staff_satisfaction_ranking==5~4,
                                            staff_satisfaction_ranking==6~3,
                                            staff_satisfaction_ranking==7~2,
                                            staff_satisfaction_ranking==8~1)) %>%
  mutate(campus_culture_score=case_when(campus_culture_ranking==1~8,
                                        campus_culture_ranking==2~7,
                                        campus_culture_ranking==3~6,
                                        campus_culture_ranking==4~5,
                                        campus_culture_ranking==5~4,
                                        campus_culture_ranking==6~3,
                                        campus_culture_ranking==7~2,
                                        campus_culture_ranking==8~1)) 
```

```{r}
survey_data <- survey_data %>%
  mutate(across(role,str_replace,"I consult on best practices","Advisor")) %>%
  mutate(across(role,str_replace,"I am a primary decision maker","Decision Maker")) %>%
  mutate(across(role,str_replace,"I offer feedback on existing services","Auditor")) %>%
  mutate(across(role,str_replace,"Other \\(please specify\\):","Advisor")) %>%
  select(-role_other)
```

```{r}
rank_frequencies <- survey_data %>%
  select(id,dietary_health_ranking,dietary_sustainability_ranking,institutional_sustainability_ranking,food_pricing_ranking,operating_costs_ranking,guest_experience_ranking,staff_satisfaction_ranking,campus_culture_ranking) %>%
  pivot_longer(!id,names_to="indicator",values_to="ranking") %>%
  mutate(across(indicator,str_replace,"guest_experience_ranking","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_ranking","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_ranking","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_ranking","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_ranking","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_ranking","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_ranking","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_ranking","Staff Satisfaction")) 
rank_frequencies %>%
  group_by(indicator) %>%
  summarise(mean_ranking=mean(ranking),sd_ranking=sd(ranking)) %>%
  arrange(mean_ranking)
```

```{r}
score_frequencies <- survey_data %>%
  select(id,dietary_health_score,dietary_sustainability_score,institutional_sustainability_score,food_pricing_score,operating_costs_score,guest_experience_score,staff_satisfaction_score,campus_culture_score) %>%
  pivot_longer(!id,names_to="indicator",values_to="score") %>%
  mutate(across(indicator,str_replace,"guest_experience_score","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_score","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_score","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_score","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_score","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_score","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_score","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_score","Staff Satisfaction"))
score_frequencies %>%
  group_by(indicator) %>%
  summarise(mean_score=mean(score),sd_score=sd(score)) %>%
  arrange(desc(mean_score))
```

```{r}
summary_score_aov <- aov(score~indicator,data=score_frequencies)
summary(summary_score_aov)
```

```{r}
TukeyHSD(summary_score_aov)
```

guest_experience_score-food_pricing_score                       0.0228131
guest_experience_score-dietary_sustainability_score             0.0384822
institutional_sustainability_score-guest_experience_score       0.0016525
guest_experience_score-campus_culture_score                     0.0008360
staff_satisfaction_score-guest_experience_score                 0.0002535

```{r}
score_frequencies %>%
  group_by(indicator) %>%
  summarise(mean_score=mean(score),sd_score=sd(score)) %>%
  arrange(desc(mean_score)) %>%
  ggplot(aes(x=fct_reorder(indicator,mean_score),y=mean_score,fill=fct_reorder(indicator,mean_score))) + 
  geom_col(color="black",size=0.2) + 
  geom_errorbar(aes(ymin=mean_score-sd_score,ymax=mean_score+sd_score),color="black",width=0.2,linewidth=0.3) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=10) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=9.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Institutional Sustainability")),color="black",size=0.25,annotation="**",y_position=9) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="*",y_position=8.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Sustainability of Guest Food Choices")),color="black",size=0.25,annotation="*",y_position=8) +
  scale_fill_viridis_d(option="mako") +
  xlab("") + 
  ylab("Mean Summary Score") +
  labs(caption="F-value: 4.81 (3sf); p-value < 0.001") + 
  coord_flip() +
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```
need to put anova value in caption - could also consider boxplot/violin plot


```{r}
summary_score_plot <- score_frequencies %>%
  ggplot(aes(x=fct_reorder(indicator,score,.fun="mean"),y=score,fill=fct_reorder(indicator,score,.fun="mean"),color=fct_reorder(indicator,score,.fun="mean"))) + 
  geom_boxplot(outlier.shape=NA,color="black",size=0.2,alpha=0.8) +
   stat_summary(fun.y=mean,geom="point",shape=20,size=2,color="black",fill="white") +
  geom_signif(comparisons=list(c("Guest Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=10) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=9.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Institutional Sustainability")),color="black",size=0.25,annotation="**",y_position=9) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="*",y_position=8.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Sustainability of Guest Food Choices")),color="black",size=0.25,annotation="*",y_position=8) +
  scale_fill_viridis_d(option="mako") +
  scale_color_viridis_d(option="mako",alpha=1) +
  xlab("") + 
  ylab("Mean Summary Score") + 
  labs(caption="F-value: 4.81 (3sf); p-value < 0.001") + 
  coord_flip() +
  theme(aspect.ratio=0.8,legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```


percent time each was ranked first 

```{r}
score_frequencies %>%
  group_by(indicator) %>%
  summarise(mean_score=mean(score),sd_score=sd(score)) %>%
  arrange(desc(mean_score)) 
```

```{r}
first_choice_frequencies <- score_frequencies %>%
  mutate(first_choice=case_when(indicator=="Guest Dining Experience"&score==8~1,
                                indicator=="Dietary Health"&score==8~1,
                                indicator=="Operating Costs"&score==8~1,
                                indicator=="Sustainability of Guest Food Choices"&score==8~1,
                                indicator=="Food Pricing"&score==8~1,
                                indicator=="Institutional Sustainability"&score==8~1,
                                indicator=="Campus Culture"&score==8~1,
                                indicator=="Staff Satisfaction"&score==8~1)) %>%
  mutate(first_choice=ifelse(is.na(first_choice),0,first_choice)) %>%
  group_by(indicator) %>%
  summarise(first_choice_frequency=sum(first_choice)) %>%
  arrange(desc(first_choice_frequency))
first_choice_frequencies
```


```{r}
first_choice_contingency_table <- first_choice_frequencies %>%
  rename(Initial=first_choice_frequency) %>%
  mutate(Noninitial=32-Initial)
first_choice_contingency_table
```

```{r}
first_choice_contingency_table <- as.table(rbind(c(9,5,5,4,4,3,2,0),c(23,27,27,28,28,29,30,32)))
dimnames(first_choice_contingency_table) <- list(dichotomy=c("Initial","Noninitial"),
                                                 indicators=c("Guest Dining Experience","Dietary Health","Institutional Sustainability","Campus Culture","Operating Costs","Food Pricing","Staff Satisfaction","Sustainability of Guest Food Choices"))
first_choice_chisq_test <- chisq.test(first_choice_contingency_table)
print(first_choice_chisq_test)
```
No significant association between the type of indicator and its likelihood of being ranked first

```{r}
first_choice_observed_counts <- first_choice_chisq_test$observed
print(first_choice_chisq_test)
```

```{r}
first_choice_expected_counts <- first_choice_chisq_test$expected
print(round(first_choice_expected_counts,2))
```

```{r}
first_choice_pearson_residuals <- first_choice_chisq_test$residuals
print(round(first_choice_pearson_residuals,2))
```

```{r}
first_choice_contributions <- (first_choice_observed_counts-first_choice_expected_counts)^2/first_choice_expected_counts
first_choice_total_chi_square <- first_choice_chisq_test$statistic
first_choice_percentage_contributions <- 100*first_choice_contributions/first_choice_total_chi_square
print("Percentage Contributions:")
```

```{r}
print(round(first_choice_percentage_contributions,2))
```

```{r}
pheatmap(first_choice_percentage_contributions,display_numbers=TRUE,cluster_rows=FALSE,cluster_cols=FALSE,main="Percentage Contributions to Chi-Square Statistic")
```

```{r}
first_choice_contingency_table <- first_choice_frequencies %>%
  rename(Initial=first_choice_frequency) %>%
  mutate(Noninitial=32-Initial) %>%
  pivot_longer(!indicator,names_to="selection",values_to="frequency") %>%
  mutate(contribution=case_when(indicator=="Guest Dining Experience"&selection=="Initial"~45.57,
    indicator=="Guest Dining Experience"&selection=="Noninitial"~6.51,
    indicator=="Dietary Health"&selection=="Initial"~1.82,
    indicator=="Dietary Health"&selection=="Noninitial"~0.26,
    indicator=="Institutional Sustainability"&selection=="Initial"~1.82,
    indicator=="Institutional Sustainability"&selection=="Noninitial"~0.26,
    indicator=="Campus Culture"&selection=="Initial"~0,
    indicator=="Campus Culture"&selection=="Noninitial"~0,
    indicator=="Operating Costs"&selection=="Initial"~0,
    indicator=="Operating Costs"&selection=="Noninitial"~0,
    indicator=="Food Pricing"&selection=="Initial"~1.82,
    indicator=="Food Pricing"&selection=="Noninitial"~0.26,
    indicator=="Staff Satisfaction"&selection=="Initial"~7.29,
    indicator=="Staff Satisfaction"&selection=="Noninitial"~1.04,
    indicator=="Sustainability of Guest Food Choices"&selection=="Initial"~29.17,
    indicator=="Sustainability of Guest Food Choices"&selection=="Noninitial"~4.17)) %>%
  mutate(label_y=case_when(selection=="Initial"~34,
                           selection=="Noninitial"~-2))
first_choice_contingency_table
```

```{r}
first_choice_frequency_plot <- ggplot(first_choice_contingency_table[order(first_choice_contingency_table$selection,decreasing=T),],aes(x=indicator,y=frequency,fill=factor(selection,levels=c("Noninitial","Initial")),color=factor(selection,levels=c("Noninitial","Initial")))) + 
  geom_col(color="black",size=0.2,alpha=0.9) + 
  geom_text(aes(y=label_y,label=paste(format(contribution,nsmall=2),"%")),color="black",size=3) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Sustainability of Guest Food Choices")),color="black",size=0.25,annotation="n.s.",y_position=34,tip_length=0.02,vjust=0) +
  xlab("Accessory Indicator") +
  ylab("Frequency") +
  scale_fill_manual(values=c("slateblue4","aquamarine3")) +
  scale_color_manual(values=c("slateblue4","aquamarine3")) +
  scale_x_discrete(limits=c("Sustainability of Guest Food Choices","Staff Satisfaction","Food Pricing","Operating Costs","Campus Culture","Institutional Sustainability","Dietary Health","Guest Dining Experience")) +
  scale_y_continuous(breaks=c(0,8,16,24,32)) +
  guides(fill=guide_legend(title="Mode"),color=guide_legend(title="Mode")) +
  labs(caption="X-squared: 13.7 (3sf); p-value = 0.056") + 
  theme(aspect.ratio=0.4,legend.position="right",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
score_frequencies %>%
  ggplot(aes(x=fct_reorder(indicator,score,.fun="mean"),y=score,fill=fct_reorder(indicator,score,.fun="mean"),color=fct_reorder(indicator,score,.fun="mean"))) + 
  geom_violin(draw_quantiles=0.5,adjust=1,alpha=0.7,size=0.2,color="black") +
  geom_jitter(width=0.33,size=2,shape=21,alpha=0.5) +
   stat_summary(fun.y=mean,geom="point",shape=20,size=2,color="black",fill="white") +
  geom_signif(comparisons=list(c("Guest Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=10) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=9.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Institutional Sustainability")),color="black",size=0.25,annotation="**",y_position=9) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="*",y_position=8.5) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Sustainability of Guest Food Choices")),color="black",size=0.25,annotation="*",y_position=8) +
  scale_fill_viridis_d(option="mako") +
  scale_color_viridis_d(option="mako",alpha=1) +
  xlab("") + 
  ylab("Mean Summary Score") + 
  labs(caption="F-value: 4.81 (3sf); p-value < 0.001") + 
  coord_flip() +
  theme(aspect.ratio=0.8,legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
preliminary_indicator_rankings <- 
ggarrange(first_choice_frequency_plot,summary_score_plot,
          nrow=2,
          labels=c("A","B"))
ggsave(filename="preliminary_indicator_rankings.png",plot=preliminary_indicator_rankings,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=38,height=30,units="cm",dpi=150,limitsize=TRUE)
preliminary_indicator_rankings
```

```{r}
priority_score_frequencies <- tibble(comparison_indicator=c("Guest Dining Experience","Dietary Health","Operating Costs","Sustainability of Guest Food Choices","Food Pricing","Institutional Sustainability","Campus Culture","Staff Satisfaction"),guest_dining_experience_selection_frequency=as.double(NA),dietary_health_selection_frequency=as.double(NA),operating_costs_selection_frequency=as.double(NA),dietary_sustainability_selection_frequency=as.double(NA),food_pricing_selection_frequency=as.double(NA),institutional_sustainability_selection_frequency=as.double(NA),campus_culture_selection_frequency=as.double(NA),staff_satisfaction_selection_frequency=as.double(NA))
priority_score_frequencies
```


```{r}
priority_score_tabulation <- survey_data %>%
  select(id,dietary_health_ranking,dietary_sustainability_ranking,institutional_sustainability_ranking,food_pricing_ranking,operating_costs_ranking,guest_experience_ranking,staff_satisfaction_ranking,campus_culture_ranking)
```

```{r}
guest_experience_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(guest_experience_over_guest_experience=0) %>%
  mutate(guest_experience_over_dietary_health=case_when(guest_experience_ranking<dietary_health_ranking~1,
                                                        guest_experience_ranking>dietary_health_ranking~0)) %>%
  mutate(guest_experience_over_operating_costs=case_when(guest_experience_ranking<operating_costs_ranking~1,
                                                        guest_experience_ranking>operating_costs_ranking~0)) %>%
  mutate(guest_experience_over_dietary_sustainability=case_when(guest_experience_ranking<dietary_sustainability_ranking~1,
                                                        guest_experience_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_food_pricing=case_when(guest_experience_ranking<food_pricing_ranking~1,
                                                        guest_experience_ranking>food_pricing_ranking~0)) %>%
   mutate(guest_experience_over_institutional_sustainability=case_when(guest_experience_ranking<institutional_sustainability_ranking~1,
                                                        guest_experience_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_campus_culture=case_when(guest_experience_ranking<campus_culture_ranking~1,
                                                        guest_experience_ranking>campus_culture_ranking~0)) %>%
  mutate(guest_experience_over_staff_satisfaction=case_when(guest_experience_ranking<staff_satisfaction_ranking~1,
                                                        guest_experience_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,guest_experience_over_dietary_health,guest_experience_over_operating_costs,guest_experience_over_dietary_sustainability,guest_experience_over_food_pricing,guest_experience_over_institutional_sustainability,guest_experience_over_campus_culture,guest_experience_over_staff_satisfaction,guest_experience_over_guest_experience) %>%
  pivot_longer(!id,names_to="condition",values_to="frequency") %>%
  group_by(condition) %>%
  summarise(instances=sum(frequency))
guest_experience_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_frequency=c(0,20,21,24,22,25,25,25))
priority_score_frequencies
```

```{r}
dietary_health_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(dietary_health_over_guest_experience=case_when(dietary_health_ranking<guest_experience_ranking~1,
                                                        dietary_health_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_health_over_dietary_health=0) %>%
  mutate(dietary_health_over_operating_costs=case_when(dietary_health_ranking<operating_costs_ranking~1,
                                                        dietary_health_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_health_over_dietary_sustainability=case_when(dietary_health_ranking<dietary_sustainability_ranking~1,
                                                        dietary_health_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_food_pricing=case_when(dietary_health_ranking<food_pricing_ranking~1,
                                                        dietary_health_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_health_over_institutional_sustainability=case_when(dietary_health_ranking<institutional_sustainability_ranking~1,
                                                        dietary_health_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_campus_culture=case_when(dietary_health_ranking<campus_culture_ranking~1,
                                                        dietary_health_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_health_over_staff_satisfaction=case_when(dietary_health_ranking<staff_satisfaction_ranking~1,
                                                        dietary_health_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_health_over_guest_experience,dietary_health_over_dietary_health,dietary_health_over_operating_costs,dietary_health_over_dietary_sustainability,dietary_health_over_food_pricing,dietary_health_over_institutional_sustainability,dietary_health_over_campus_culture,dietary_health_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
dietary_health_priority_score_tabulation
```


```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(dietary_health_selection_frequency=c(12,0,17,22,19,19,21,23))
priority_score_frequencies
```

```{r}
operating_costs_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(operating_costs_over_guest_experience=case_when(operating_costs_ranking<guest_experience_ranking~1,
                                                        operating_costs_ranking>guest_experience_ranking~0)) %>%
  mutate(operating_costs_over_dietary_health=case_when(operating_costs_ranking<dietary_health_ranking~1,
                                                        operating_costs_ranking>dietary_health_ranking~0)) %>%
  mutate(operating_costs_over_operating_costs=0) %>%
  mutate(operating_costs_over_dietary_sustainability=case_when(operating_costs_ranking<dietary_sustainability_ranking~1,
                                                        operating_costs_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_food_pricing=case_when(operating_costs_ranking<food_pricing_ranking~1,
                                                        operating_costs_ranking>food_pricing_ranking~0)) %>%
  mutate(operating_costs_over_institutional_sustainability=case_when(operating_costs_ranking<institutional_sustainability_ranking~1,
                                                        operating_costs_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_campus_culture=case_when(operating_costs_ranking<campus_culture_ranking~1,
                                                        operating_costs_ranking>campus_culture_ranking~0)) %>%
  mutate(operating_costs_over_staff_satisfaction=case_when(operating_costs_ranking<staff_satisfaction_ranking~1,
                                                        operating_costs_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,operating_costs_over_guest_experience,operating_costs_over_dietary_health,operating_costs_over_operating_costs,operating_costs_over_dietary_sustainability,operating_costs_over_food_pricing,operating_costs_over_institutional_sustainability,operating_costs_over_campus_culture,operating_costs_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
operating_costs_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(operating_costs_selection_frequency=c(11,15,0,18,21,22,20,21))
priority_score_frequencies
```

```{r}
dietary_sustainability_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(dietary_sustainability_over_guest_experience=case_when(dietary_sustainability_ranking<guest_experience_ranking~1,
                                                        dietary_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_health=case_when(dietary_sustainability_ranking<dietary_health_ranking~1,
                                                        dietary_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(dietary_sustainability_over_operating_costs=case_when(dietary_sustainability_ranking<operating_costs_ranking~1,
                                                        dietary_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_sustainability=0) %>%
  mutate(dietary_sustainability_over_food_pricing=case_when(dietary_sustainability_ranking<food_pricing_ranking~1,
                                                        dietary_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_sustainability_over_institutional_sustainability=case_when(dietary_sustainability_ranking<institutional_sustainability_ranking~1,
                                                        dietary_sustainability_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_sustainability_over_campus_culture=case_when(dietary_sustainability_ranking<campus_culture_ranking~1,
                                                        dietary_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_sustainability_over_staff_satisfaction=case_when(dietary_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        dietary_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_sustainability_over_guest_experience,dietary_sustainability_over_dietary_health,dietary_sustainability_over_operating_costs,dietary_sustainability_over_dietary_sustainability,dietary_sustainability_over_food_pricing,dietary_sustainability_over_institutional_sustainability,dietary_sustainability_over_campus_culture,dietary_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
dietary_sustainability_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(dietary_sustainability_selection_frequency=c(8,10,14,0,17,17,21,20)) 
priority_score_frequencies
```

```{r}
food_pricing_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(food_pricing_over_guest_experience=case_when(food_pricing_ranking<guest_experience_ranking~1,
                                                        food_pricing_ranking>guest_experience_ranking~0)) %>%
  mutate(food_pricing_over_dietary_health=case_when(food_pricing_ranking<dietary_health_ranking~1,
                                                        food_pricing_ranking>dietary_health_ranking~0)) %>%
  mutate(food_pricing_over_operating_costs=case_when(food_pricing_ranking<operating_costs_ranking~1,
                                                        food_pricing_ranking>operating_costs_ranking~0)) %>%
  mutate(food_pricing_over_dietary_sustainability=case_when(food_pricing_ranking<dietary_sustainability_ranking~1,
                                                        food_pricing_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_food_pricing=0) %>%
  mutate(food_pricing_over_institutional_sustainability=case_when(food_pricing_ranking<institutional_sustainability_ranking~1,
                                                        food_pricing_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_campus_culture=case_when(food_pricing_ranking<campus_culture_ranking~1,
                                                        food_pricing_ranking>campus_culture_ranking~0)) %>%
  mutate(food_pricing_over_staff_satisfaction=case_when(food_pricing_ranking<staff_satisfaction_ranking~1,
                                                        food_pricing_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,food_pricing_over_guest_experience,food_pricing_over_dietary_health,food_pricing_over_operating_costs,food_pricing_over_dietary_sustainability,food_pricing_over_food_pricing,food_pricing_over_institutional_sustainability,food_pricing_over_campus_culture,food_pricing_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
food_pricing_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(food_pricing_selection_frequency=c(10,13,11,15,0,17,18,20))
priority_score_frequencies
```

```{r}
institutional_sustainability_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(institutional_sustainability_over_guest_experience=case_when(institutional_sustainability_ranking<guest_experience_ranking~1,
                                                        institutional_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_health=case_when(institutional_sustainability_ranking<dietary_health_ranking~1,
                                                        institutional_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(institutional_sustainability_over_operating_costs=case_when(institutional_sustainability_ranking<operating_costs_ranking~1,
                                                        institutional_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_sustainability=case_when(institutional_sustainability_ranking<dietary_sustainability_ranking~1,
                                                        institutional_sustainability_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(institutional_sustainability_over_food_pricing=case_when(institutional_sustainability_ranking<food_pricing_ranking~1,
                                                        institutional_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(institutional_sustainability_over_institutional_sustainability=0) %>%
  mutate(institutional_sustainability_over_campus_culture=case_when(institutional_sustainability_ranking<campus_culture_ranking~1,
                                                        institutional_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(institutional_sustainability_over_staff_satisfaction=case_when(institutional_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        institutional_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,institutional_sustainability_over_guest_experience,institutional_sustainability_over_dietary_health,institutional_sustainability_over_operating_costs,institutional_sustainability_over_dietary_sustainability,institutional_sustainability_over_food_pricing,institutional_sustainability_over_institutional_sustainability,institutional_sustainability_over_campus_culture,institutional_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
institutional_sustainability_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(institutional_sustainability_selection_frequency=c(7,13,10,15,15,0,15,16))
priority_score_frequencies
```

```{r}
campus_culture_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(campus_culture_over_guest_experience=case_when(campus_culture_ranking<guest_experience_ranking~1,
                                                        campus_culture_ranking>guest_experience_ranking~0)) %>%
  mutate(campus_culture_over_dietary_health=case_when(campus_culture_ranking<dietary_health_ranking~1,
                                                        campus_culture_ranking>dietary_health_ranking~0)) %>%
  mutate(campus_culture_over_operating_costs=case_when(campus_culture_ranking<operating_costs_ranking~1,
                                                        campus_culture_ranking>operating_costs_ranking~0)) %>%
  mutate(campus_culture_over_dietary_sustainability=case_when(campus_culture_ranking<dietary_sustainability_ranking~1,
                                                        campus_culture_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_food_pricing=case_when(campus_culture_ranking<food_pricing_ranking~1,
                                                        campus_culture_ranking>food_pricing_ranking~0)) %>%
  mutate(campus_culture_over_institutional_sustainability=case_when(campus_culture_ranking<institutional_sustainability_ranking~1,
                                                        campus_culture_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_campus_culture=0) %>%
  mutate(campus_culture_over_staff_satisfaction=case_when(campus_culture_ranking<staff_satisfaction_ranking~1,
                                                        campus_culture_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,campus_culture_over_guest_experience,campus_culture_over_dietary_health,campus_culture_over_operating_costs,campus_culture_over_dietary_sustainability,campus_culture_over_food_pricing,campus_culture_over_institutional_sustainability,campus_culture_over_campus_culture,campus_culture_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
campus_culture_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(campus_culture_selection_frequency=c(7,11,12,11,14,17,0,16))
priority_score_frequencies
```

```{r}
staff_satisfaction_priority_score_tabulation <- priority_score_tabulation %>%
  mutate(staff_satisfaction_over_guest_experience=case_when(staff_satisfaction_ranking<guest_experience_ranking~1,
                                                        staff_satisfaction_ranking>guest_experience_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_health=case_when(staff_satisfaction_ranking<dietary_health_ranking~1,
                                                        staff_satisfaction_ranking>dietary_health_ranking~0)) %>%
  mutate(staff_satisfaction_over_operating_costs=case_when(staff_satisfaction_ranking<operating_costs_ranking~1,
                                                        staff_satisfaction_ranking>operating_costs_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_sustainability=case_when(staff_satisfaction_ranking<dietary_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_food_pricing=case_when(staff_satisfaction_ranking<food_pricing_ranking~1,
                                                        staff_satisfaction_ranking>food_pricing_ranking~0)) %>%
  mutate(staff_satisfaction_over_institutional_sustainability=case_when(staff_satisfaction_ranking<institutional_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_campus_culture=case_when(staff_satisfaction_ranking<campus_culture_ranking~1,
                                                        staff_satisfaction_ranking>campus_culture_ranking~0)) %>%
  mutate(staff_satisfaction_over_staff_satisfaction=0) %>%
  select(id,staff_satisfaction_over_guest_experience,staff_satisfaction_over_dietary_health,staff_satisfaction_over_operating_costs,staff_satisfaction_over_dietary_sustainability,staff_satisfaction_over_food_pricing,staff_satisfaction_over_institutional_sustainability,staff_satisfaction_over_campus_culture,staff_satisfaction_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
staff_satisfaction_priority_score_tabulation
```

```{r}
priority_score_frequencies <- priority_score_frequencies %>%
  mutate(staff_satisfaction_selection_frequency=c(7,9,11,12,12,16,16,0)) 
priority_score_frequencies
```

```{r}
priority_score_probabilities <- priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_probability=guest_dining_experience_selection_frequency/32,.after=guest_dining_experience_selection_frequency) %>%
  mutate(dietary_health_selection_probability=dietary_health_selection_frequency/32,.after=dietary_health_selection_frequency) %>%
  mutate(operating_costs_selection_probability=operating_costs_selection_frequency/32,.after=operating_costs_selection_frequency) %>%
   mutate(dietary_sustainability_selection_probability=dietary_sustainability_selection_frequency/32,.after=dietary_sustainability_selection_frequency) %>%
  mutate(food_pricing_selection_probability=food_pricing_selection_frequency/32,.after=food_pricing_selection_frequency) %>%
  mutate(institutional_sustainability_selection_probability=institutional_sustainability_selection_frequency/32,.after=institutional_sustainability_selection_frequency) %>%
  mutate(campus_culture_selection_probability=campus_culture_selection_frequency/32,.after=campus_culture_selection_frequency) %>%
   mutate(staff_satisfaction_selection_probability=staff_satisfaction_selection_frequency/32,.after=staff_satisfaction_selection_frequency)
priority_score_probabilities
```

```{r}
priority_score_zscores <- priority_score_probabilities %>%
  mutate(guest_dining_experience_selection_zscore=scale(guest_dining_experience_selection_probability),.after=guest_dining_experience_selection_probability) %>%
  mutate(dietary_health_selection_zscore=scale(dietary_health_selection_probability),.after=dietary_health_selection_probability) %>%
  mutate(operating_costs_selection_zscore=scale(operating_costs_selection_probability),.after=operating_costs_selection_probability) %>%
  mutate(dietary_sustainability_selection_zscore=scale(dietary_sustainability_selection_probability),.after=dietary_sustainability_selection_probability) %>%
  mutate(food_pricing_selection_zscore=scale(food_pricing_selection_probability),.after=food_pricing_selection_probability) %>%
  mutate(institutional_sustainability_selection_zscore=scale(institutional_sustainability_selection_probability),.after=institutional_sustainability_selection_probability) %>%
  mutate(campus_culture_selection_zscore=scale(campus_culture_selection_probability),.after=campus_culture_selection_probability) %>%
  mutate(staff_satisfaction_selection_zscore=scale(staff_satisfaction_selection_probability),.after=staff_satisfaction_selection_probability) 
priority_score_zscores
```

```{r}
priority_frequency_table <- priority_score_zscores %>%
  select(comparison_indicator,guest_dining_experience_selection_frequency,dietary_health_selection_frequency,operating_costs_selection_frequency,dietary_sustainability_selection_frequency,food_pricing_selection_frequency,institutional_sustainability_selection_frequency,campus_culture_selection_frequency,staff_satisfaction_selection_frequency) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="frequency") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_frequency","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_frequency","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_frequency","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_frequency","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_frequency","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_frequency","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_frequency","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_frequency","Staff Satisfaction")) %>%
  filter(frequency>0)
priority_frequency_table
```

```{r}
priority_frequency_table %>%
  group_by(indicator) %>%
  summarise(total_selection_frequency=sum(frequency),mean_selection_frequency=mean(frequency)) %>%
  arrange(desc(mean_selection_frequency))
```

```{r}
priority_frequency_table %>%
  group_by(indicator) %>%
  summarise(total_selection_frequency=sum(frequency),mean_selection_frequency=mean(frequency)) %>%
  arrange(desc(mean_selection_frequency)) %>%
  summarise(mean=mean(mean_selection_frequency))
```


```{r}
selection_frequency_aov <- aov(frequency~indicator,data=priority_frequency_table)
summary(selection_frequency_aov)
```
There is a significant association between the type of accessory indicator and its selection frequency (i.e., the chance that the indicator will be selected over others) 

```{r}
TukeyHSD(selection_frequency_aov)
```
Dietary Health-Campus Culture                                     12.5792133 0.0346700
Guest Dining Experience-Campus Culture                            16.7220705 0.0000454
Staff Satisfaction-Dietary Health                                 -0.9922152 0.0127043
Guest Dining Experience-Food Pricing                              14.4363562 0.0021892
Institutional Sustainability-Guest Dining Experience              -3.9922152 0.0000962
Staff Satisfaction-Guest Dining Experience                        -5.1350724 0.0000128
Sustainability of Guest Food Choices-Guest Dining Experience      -1.7065009 0.0043134
Staff Satisfaction-Operating Costs                                -0.2779295 0.0346700


```{r}
selection_frequency_plot <- priority_frequency_table %>%
  ggplot(aes(x=fct_reorder(indicator,frequency,.fun="mean"),y=frequency,fill=fct_reorder(indicator,frequency,.fun="mean"),color=fct_reorder(indicator,frequency,.fun="mean"))) +
  geom_boxplot(outlier.shape=NA,color="black",size=0.2,alpha=0.8) +
  geom_hline(yintercept=16,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Guest Dining Experience")),color="black",size=0.25,annotation="***",y_position=2,tip_length=-0.02,vjust=3) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=3,tip_length=-0.02,vjust=3) +
  geom_signif(comparisons=list(c("Institutional Sustainability","Guest Dining Experience")),color="black",size=0.25,annotation="***",y_position=4,tip_length=-.02,vjust=3) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="**",y_position=5,tip_length=-0.02,vjust=3) +
  geom_signif(comparisons=list(c("Sustainability of Guest Food Choices","Guest Dining Experience")),color="black",size=0.25,annotation="**",y_position=6,tip_length=-0.02,vjust=3) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Operating Costs")),color="black",size=0.25,annotation="*",y_position=22,tip_length=0.02,vjust=0.5) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Dietary Health")),color="black",size=0.25,annotation="**",y_position=23,tip_length=0.02,vjust=0.5) +
  geom_signif(comparisons=list(c("Dietary Health","Campus Culture")),color="black",size=0.25,annotation="*",y_position=24,tip_length=0.02,vjust=0.5) +
  stat_summary(fun.y=mean,geom="point",shape=20,size=2,color="black",fill="white") +
  scale_fill_viridis_d(option="mako") +
  scale_color_viridis_d(option="mako",alpha=1) +
  scale_y_continuous(breaks=c(1,4,7,10,13,16,19,22,25,28)) +
  xlab("") + 
  ylab("Selection Frequency") + 
  labs(caption="F-value: 7.96 (3sf); p-value < 0.001") + 
  coord_flip() +
  theme(aspect.ratio=0.8,legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
priority_probability_table <- priority_score_zscores %>%
  select(comparison_indicator,guest_dining_experience_selection_probability,dietary_health_selection_probability,operating_costs_selection_probability,dietary_sustainability_selection_probability,food_pricing_selection_probability,institutional_sustainability_selection_probability,campus_culture_selection_probability,staff_satisfaction_selection_probability) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="probability") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_probability","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_probability","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_probability","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_probability","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_probability","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_probability","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_probability","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_probability","Staff Satisfaction")) %>%
  filter(probability>0)
priority_probability_table
```

```{r}
priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability))
```


```{r}
priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability)) %>%
  summarise(mean=mean(mean_selection_probability))
```


```{r}
selection_probability_aov <- aov(probability~indicator,data=priority_probability_table)
summary(selection_probability_aov)
```

```{r}
TukeyHSD(selection_probability_aov)
```

Dietary Health-Campus Culture                                      0.20089286  0.008685297  0.393100417 0.0346700
Guest Dining Experience-Campus Culture                             0.33035714  0.138149583  0.522564703 0.0000454
Staff Satisfaction-Dietary Health                                 -0.22321429 -0.415421845 -0.031006726 0.0127043
Guest Dining Experience-Food Pricing                               0.25892857  0.066721012  0.451136131 0.0021892
Institutional Sustainability-Guest Dining Experience              -0.31696429 -0.509171845 -0.124756726 0.0000962
Staff Satisfaction-Guest Dining Experience                        -0.35267857 -0.544886131 -0.160471012 0.0000128
Sustainability of Guest Food Choices-Guest Dining Experience      -0.24553571 -0.437743274 -0.053328155 0.0043134
Staff Satisfaction-Operating Costs                                -0.20089286 -0.393100417 -0.008685297 0.0346700


```{r}
selection_probability_plot <- priority_probability_table %>%
  ggplot(aes(x=fct_reorder(indicator,probability,.fun="mean"),y=probability,fill=fct_reorder(indicator,probability,.fun="mean"),color=fct_reorder(indicator,probability,.fun="mean"))) +
  geom_violin(color="black",draw_quantiles=0.5,alpha=0.6,size=0.2,adjust=1) +
  geom_hline(yintercept=0.5,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Guest Dining Experience")),color="black",size=0.25,annotation="***",y_position=0.13,tip_length=-0.02,vjust=2.6) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=0.15,tip_length=-0.02,vjust=2.6) +
  geom_signif(comparisons=list(c("Institutional Sustainability","Guest Dining Experience")),color="black",size=0.25,annotation="***",y_position=0.17,tip_length=-.02,vjust=2.6) +

  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="**",y_position=0.19,tip_length=-0.02,vjust=2.6) +
  geom_signif(comparisons=list(c("Sustainability of Guest Food Choices","Guest Dining Experience")),color="black",size=0.25,annotation="**",y_position=0.21,tip_length=-0.02,vjust=2.6) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Operating Costs")),color="black",size=0.25,annotation="*",y_position=0.77,tip_length=0.02,vjust=0.6) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Dietary Health")),color="black",size=0.25,annotation="**",y_position=0.79,tip_length=0.02,vjust=0.6) +
  geom_signif(comparisons=list(c("Dietary Health","Campus Culture")),color="black",size=0.25,annotation="*",y_position=0.81,tip_length=0.02,vjust=0.6) +
  stat_summary(fun.y=mean,geom="point",shape=4,size=1.75,color="black") +
  scale_fill_viridis_d(option="mako",limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  scale_color_viridis_d(option="mako",alpha=1) +
  scale_y_continuous(breaks=c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9),limits=c(0.15,0.85)) +
  xlab("") + 
  ylab("Selection Probability") + 
  labs(caption="F-value: 7.96 (3sf); p-value < 0.001",subtitle="Aggregate Sample (n=32)") + 
  coord_flip() +
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10),plot.subtitle=element_text(size=10,hjust=1),plot.caption=element_text(size=8),axis.title=element_text(size=10),axis.text=element_text(size=8))
selection_probability_plot
```
geom_jitter(width=0.33,size=2,shape=21,alpha=0.5) +

stat_summary(data=technical_advisor_priority_probability_table,fun.y=mean,geom="point",shape=1,size=1.75,color="black") +
  stat_summary(data=decision_maker_priority_probability_table,fun.y=mean,geom="point",shape=19,size=1.75,color="black",fill="black") +

decomp next for advisors, decision makers

repeated the above processes by group (technical advisors) vs (strategic decision makers)

```{r}
survey_data %>%
  group_by(role) %>%
  summarise(count=n())
```

```{r}
survey_data %>%
  select(role,stakeholder_type,stakeholder_type_other)
```

```{r}
survey_data %>%
  filter(role=="Advisor")
```

```{r}
survey_data %>%
  filter(role=="Decision Maker") 
```

```{r}
decision_maker_priority_score_frequencies <- tibble(comparison_indicator=c("Guest Dining Experience","Dietary Health","Operating Costs","Sustainability of Guest Food Choices","Food Pricing","Institutional Sustainability","Campus Culture","Staff Satisfaction"),guest_dining_experience_selection_frequency=as.double(NA),dietary_health_selection_frequency=as.double(NA),operating_costs_selection_frequency=as.double(NA),dietary_sustainability_selection_frequency=as.double(NA),food_pricing_selection_frequency=as.double(NA),institutional_sustainability_selection_frequency=as.double(NA),campus_culture_selection_frequency=as.double(NA),staff_satisfaction_selection_frequency=as.double(NA))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_priority_score_tabulation <- survey_data %>%
  filter(role=="Decision Maker") %>%
  select(id,dietary_health_ranking,dietary_sustainability_ranking,institutional_sustainability_ranking,food_pricing_ranking,operating_costs_ranking,guest_experience_ranking,staff_satisfaction_ranking,campus_culture_ranking)
decision_maker_priority_score_tabulation
```

```{r}
decision_maker_guest_experience_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(guest_experience_over_guest_experience=0) %>%
  mutate(guest_experience_over_dietary_health=case_when(guest_experience_ranking<dietary_health_ranking~1,
                                                        guest_experience_ranking>dietary_health_ranking~0)) %>%
  mutate(guest_experience_over_operating_costs=case_when(guest_experience_ranking<operating_costs_ranking~1,
                                                        guest_experience_ranking>operating_costs_ranking~0)) %>%
  mutate(guest_experience_over_dietary_sustainability=case_when(guest_experience_ranking<dietary_sustainability_ranking~1,
                                                        guest_experience_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_food_pricing=case_when(guest_experience_ranking<food_pricing_ranking~1,
                                                        guest_experience_ranking>food_pricing_ranking~0)) %>%
   mutate(guest_experience_over_institutional_sustainability=case_when(guest_experience_ranking<institutional_sustainability_ranking~1,
                                                        guest_experience_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_campus_culture=case_when(guest_experience_ranking<campus_culture_ranking~1,
                                                        guest_experience_ranking>campus_culture_ranking~0)) %>%
  mutate(guest_experience_over_staff_satisfaction=case_when(guest_experience_ranking<staff_satisfaction_ranking~1,
                                                        guest_experience_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,guest_experience_over_dietary_health,guest_experience_over_operating_costs,guest_experience_over_dietary_sustainability,guest_experience_over_food_pricing,guest_experience_over_institutional_sustainability,guest_experience_over_campus_culture,guest_experience_over_staff_satisfaction,guest_experience_over_guest_experience) %>%
  pivot_longer(!id,names_to="condition",values_to="frequency") %>%
  group_by(condition) %>%
  summarise(instances=sum(frequency))
decision_maker_guest_experience_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_frequency=c(0,8,7,8,8,9,9,8))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_dietary_health_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(dietary_health_over_guest_experience=case_when(dietary_health_ranking<guest_experience_ranking~1,
                                                        dietary_health_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_health_over_dietary_health=0) %>%
  mutate(dietary_health_over_operating_costs=case_when(dietary_health_ranking<operating_costs_ranking~1,
                                                        dietary_health_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_health_over_dietary_sustainability=case_when(dietary_health_ranking<dietary_sustainability_ranking~1,
                                                        dietary_health_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_food_pricing=case_when(dietary_health_ranking<food_pricing_ranking~1,
                                                        dietary_health_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_health_over_institutional_sustainability=case_when(dietary_health_ranking<institutional_sustainability_ranking~1,
                                                        dietary_health_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_campus_culture=case_when(dietary_health_ranking<campus_culture_ranking~1,
                                                        dietary_health_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_health_over_staff_satisfaction=case_when(dietary_health_ranking<staff_satisfaction_ranking~1,
                                                        dietary_health_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_health_over_guest_experience,dietary_health_over_dietary_health,dietary_health_over_operating_costs,dietary_health_over_dietary_sustainability,dietary_health_over_food_pricing,dietary_health_over_institutional_sustainability,dietary_health_over_campus_culture,dietary_health_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_dietary_health_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(dietary_health_selection_frequency=c(4,0,6,6,7,6,8,8))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_operating_costs_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(operating_costs_over_guest_experience=case_when(operating_costs_ranking<guest_experience_ranking~1,
                                                        operating_costs_ranking>guest_experience_ranking~0)) %>%
  mutate(operating_costs_over_dietary_health=case_when(operating_costs_ranking<dietary_health_ranking~1,
                                                        operating_costs_ranking>dietary_health_ranking~0)) %>%
  mutate(operating_costs_over_operating_costs=0) %>%
  mutate(operating_costs_over_dietary_sustainability=case_when(operating_costs_ranking<dietary_sustainability_ranking~1,
                                                        operating_costs_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_food_pricing=case_when(operating_costs_ranking<food_pricing_ranking~1,
                                                        operating_costs_ranking>food_pricing_ranking~0)) %>%
  mutate(operating_costs_over_institutional_sustainability=case_when(operating_costs_ranking<institutional_sustainability_ranking~1,
                                                        operating_costs_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_campus_culture=case_when(operating_costs_ranking<campus_culture_ranking~1,
                                                        operating_costs_ranking>campus_culture_ranking~0)) %>%
  mutate(operating_costs_over_staff_satisfaction=case_when(operating_costs_ranking<staff_satisfaction_ranking~1,
                                                        operating_costs_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,operating_costs_over_guest_experience,operating_costs_over_dietary_health,operating_costs_over_operating_costs,operating_costs_over_dietary_sustainability,operating_costs_over_food_pricing,operating_costs_over_institutional_sustainability,operating_costs_over_campus_culture,operating_costs_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_operating_costs_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>% 
  mutate(operating_costs_selection_frequency=c(5,6,0,8,7,8,7,6))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_dietary_sustainability_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(dietary_sustainability_over_guest_experience=case_when(dietary_sustainability_ranking<guest_experience_ranking~1,
                                                        dietary_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_health=case_when(dietary_sustainability_ranking<dietary_health_ranking~1,
                                                        dietary_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(dietary_sustainability_over_operating_costs=case_when(dietary_sustainability_ranking<operating_costs_ranking~1,
                                                        dietary_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_sustainability=0) %>%
  mutate(dietary_sustainability_over_food_pricing=case_when(dietary_sustainability_ranking<food_pricing_ranking~1,
                                                        dietary_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_sustainability_over_institutional_sustainability=case_when(dietary_sustainability_ranking<institutional_sustainability_ranking~1,
                                                        dietary_sustainability_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_sustainability_over_campus_culture=case_when(dietary_sustainability_ranking<campus_culture_ranking~1,
                                                        dietary_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_sustainability_over_staff_satisfaction=case_when(dietary_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        dietary_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_sustainability_over_guest_experience,dietary_sustainability_over_dietary_health,dietary_sustainability_over_operating_costs,dietary_sustainability_over_dietary_sustainability,dietary_sustainability_over_food_pricing,dietary_sustainability_over_institutional_sustainability,dietary_sustainability_over_campus_culture,dietary_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_dietary_sustainability_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(dietary_sustainability_selection_frequency=c(4,6,4,0,4,7,8,6))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_food_pricing_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(food_pricing_over_guest_experience=case_when(food_pricing_ranking<guest_experience_ranking~1,
                                                        food_pricing_ranking>guest_experience_ranking~0)) %>%
  mutate(food_pricing_over_dietary_health=case_when(food_pricing_ranking<dietary_health_ranking~1,
                                                        food_pricing_ranking>dietary_health_ranking~0)) %>%
  mutate(food_pricing_over_operating_costs=case_when(food_pricing_ranking<operating_costs_ranking~1,
                                                        food_pricing_ranking>operating_costs_ranking~0)) %>%
  mutate(food_pricing_over_dietary_sustainability=case_when(food_pricing_ranking<dietary_sustainability_ranking~1,
                                                        food_pricing_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_food_pricing=0) %>%
  mutate(food_pricing_over_institutional_sustainability=case_when(food_pricing_ranking<institutional_sustainability_ranking~1,
                                                        food_pricing_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_campus_culture=case_when(food_pricing_ranking<campus_culture_ranking~1,
                                                        food_pricing_ranking>campus_culture_ranking~0)) %>%
  mutate(food_pricing_over_staff_satisfaction=case_when(food_pricing_ranking<staff_satisfaction_ranking~1,
                                                        food_pricing_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,food_pricing_over_guest_experience,food_pricing_over_dietary_health,food_pricing_over_operating_costs,food_pricing_over_dietary_sustainability,food_pricing_over_food_pricing,food_pricing_over_institutional_sustainability,food_pricing_over_campus_culture,food_pricing_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_food_pricing_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(food_pricing_selection_frequency=c(4,5,5,8,0,7,8,7))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_institutional_sustainability_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(institutional_sustainability_over_guest_experience=case_when(institutional_sustainability_ranking<guest_experience_ranking~1,
                                                        institutional_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_health=case_when(institutional_sustainability_ranking<dietary_health_ranking~1,
                                                        institutional_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(institutional_sustainability_over_operating_costs=case_when(institutional_sustainability_ranking<operating_costs_ranking~1,
                                                        institutional_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_sustainability=case_when(institutional_sustainability_ranking<dietary_sustainability_ranking~1,
                                                        institutional_sustainability_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(institutional_sustainability_over_food_pricing=case_when(institutional_sustainability_ranking<food_pricing_ranking~1,
                                                        institutional_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(institutional_sustainability_over_institutional_sustainability=0) %>%
  mutate(institutional_sustainability_over_campus_culture=case_when(institutional_sustainability_ranking<campus_culture_ranking~1,
                                                        institutional_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(institutional_sustainability_over_staff_satisfaction=case_when(institutional_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        institutional_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,institutional_sustainability_over_guest_experience,institutional_sustainability_over_dietary_health,institutional_sustainability_over_operating_costs,institutional_sustainability_over_dietary_sustainability,institutional_sustainability_over_food_pricing,institutional_sustainability_over_institutional_sustainability,institutional_sustainability_over_campus_culture,institutional_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_institutional_sustainability_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>% 
  mutate(institutional_sustainability_selection_frequency=c(3,6,4,5,5,0,6,6))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_campus_culture_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(campus_culture_over_guest_experience=case_when(campus_culture_ranking<guest_experience_ranking~1,
                                                        campus_culture_ranking>guest_experience_ranking~0)) %>%
  mutate(campus_culture_over_dietary_health=case_when(campus_culture_ranking<dietary_health_ranking~1,
                                                        campus_culture_ranking>dietary_health_ranking~0)) %>%
  mutate(campus_culture_over_operating_costs=case_when(campus_culture_ranking<operating_costs_ranking~1,
                                                        campus_culture_ranking>operating_costs_ranking~0)) %>%
  mutate(campus_culture_over_dietary_sustainability=case_when(campus_culture_ranking<dietary_sustainability_ranking~1,
                                                        campus_culture_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_food_pricing=case_when(campus_culture_ranking<food_pricing_ranking~1,
                                                        campus_culture_ranking>food_pricing_ranking~0)) %>%
  mutate(campus_culture_over_institutional_sustainability=case_when(campus_culture_ranking<institutional_sustainability_ranking~1,
                                                        campus_culture_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_campus_culture=0) %>%
  mutate(campus_culture_over_staff_satisfaction=case_when(campus_culture_ranking<staff_satisfaction_ranking~1,
                                                        campus_culture_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,campus_culture_over_guest_experience,campus_culture_over_dietary_health,campus_culture_over_operating_costs,campus_culture_over_dietary_sustainability,campus_culture_over_food_pricing,campus_culture_over_institutional_sustainability,campus_culture_over_campus_culture,campus_culture_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_campus_culture_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(campus_culture_selection_frequency=c(3,4,5,4,4,6,0,4))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_staff_satisfaction_priority_score_tabulation <- decision_maker_priority_score_tabulation %>%
  mutate(staff_satisfaction_over_guest_experience=case_when(staff_satisfaction_ranking<guest_experience_ranking~1,
                                                        staff_satisfaction_ranking>guest_experience_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_health=case_when(staff_satisfaction_ranking<dietary_health_ranking~1,
                                                        staff_satisfaction_ranking>dietary_health_ranking~0)) %>%
  mutate(staff_satisfaction_over_operating_costs=case_when(staff_satisfaction_ranking<operating_costs_ranking~1,
                                                        staff_satisfaction_ranking>operating_costs_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_sustainability=case_when(staff_satisfaction_ranking<dietary_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_food_pricing=case_when(staff_satisfaction_ranking<food_pricing_ranking~1,
                                                        staff_satisfaction_ranking>food_pricing_ranking~0)) %>%
  mutate(staff_satisfaction_over_institutional_sustainability=case_when(staff_satisfaction_ranking<institutional_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_campus_culture=case_when(staff_satisfaction_ranking<campus_culture_ranking~1,
                                                        staff_satisfaction_ranking>campus_culture_ranking~0)) %>%
  mutate(staff_satisfaction_over_staff_satisfaction=0) %>%
  select(id,staff_satisfaction_over_guest_experience,staff_satisfaction_over_dietary_health,staff_satisfaction_over_operating_costs,staff_satisfaction_over_dietary_sustainability,staff_satisfaction_over_food_pricing,staff_satisfaction_over_institutional_sustainability,staff_satisfaction_over_campus_culture,staff_satisfaction_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
decision_maker_staff_satisfaction_priority_score_tabulation
```

```{r}
decision_maker_priority_score_frequencies <- decision_maker_priority_score_frequencies %>%
  mutate(staff_satisfaction_selection_frequency=c(4,4,6,6,5,6,8,0))
decision_maker_priority_score_frequencies
```

```{r}
decision_maker_priority_score_probabilities <- decision_maker_priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_probability=guest_dining_experience_selection_frequency/12,.after=guest_dining_experience_selection_frequency) %>%
  mutate(dietary_health_selection_probability=dietary_health_selection_frequency/12,.after=dietary_health_selection_frequency) %>%
  mutate(operating_costs_selection_probability=operating_costs_selection_frequency/12,.after=operating_costs_selection_frequency) %>%
   mutate(dietary_sustainability_selection_probability=dietary_sustainability_selection_frequency/12,.after=dietary_sustainability_selection_frequency) %>%
  mutate(food_pricing_selection_probability=food_pricing_selection_frequency/12,.after=food_pricing_selection_frequency) %>%
  mutate(institutional_sustainability_selection_probability=institutional_sustainability_selection_frequency/12,.after=institutional_sustainability_selection_frequency) %>%
  mutate(campus_culture_selection_probability=campus_culture_selection_frequency/12,.after=campus_culture_selection_frequency) %>%
   mutate(staff_satisfaction_selection_probability=staff_satisfaction_selection_frequency/12,.after=staff_satisfaction_selection_frequency)
decision_maker_priority_score_probabilities
```

```{r}
decision_maker_priority_frequency_table <- decision_maker_priority_score_probabilities %>%
  select(comparison_indicator,guest_dining_experience_selection_frequency,dietary_health_selection_frequency,operating_costs_selection_frequency,dietary_sustainability_selection_frequency,food_pricing_selection_frequency,institutional_sustainability_selection_frequency,campus_culture_selection_frequency,staff_satisfaction_selection_frequency) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="frequency") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_frequency","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_frequency","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_frequency","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_frequency","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_frequency","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_frequency","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_frequency","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_frequency","Staff Satisfaction")) %>%
  filter(frequency>0)
decision_maker_priority_frequency_table
```

```{r}
decision_maker_priority_frequency_table %>%
  group_by(indicator) %>%
  summarise(total_selection_frequency=sum(frequency),mean_selection_frequency=mean(frequency)) %>%
  arrange(desc(mean_selection_frequency)) %>%
  summarise(mean=mean(mean_selection_frequency))
```


```{r}
decision_maker_priority_probability_table <- decision_maker_priority_score_probabilities %>%
  select(comparison_indicator,guest_dining_experience_selection_probability,dietary_health_selection_probability,operating_costs_selection_probability,dietary_sustainability_selection_probability,food_pricing_selection_probability,institutional_sustainability_selection_probability,campus_culture_selection_probability,staff_satisfaction_selection_probability) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="probability") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_probability","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_probability","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_probability","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_probability","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_probability","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_probability","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_probability","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_probability","Staff Satisfaction")) %>%
  filter(probability>0)
decision_maker_priority_probability_table
```

```{r}
decision_maker_priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability))
```

```{r}
decision_maker_priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability)) %>%
  summarise(mean=mean(mean_selection_probability))
```

```{r}
decision_maker_selection_probability_aov <- aov(probability~indicator,data=decision_maker_priority_probability_table)
summary(decision_maker_selection_probability_aov)
```

```{r}
TukeyHSD(decision_maker_selection_probability_aov)
```

Dietary Health-Campus Culture                                      0.0357605 *
Guest Dining Experience-Campus Culture                             0.0000082 ***
Operating Costs-Campus Culture                                     0.0106998 *
Guest Dining Experience-Food Pricing                               0.0003491 ***
Institutional Sustainability-Guest Dining Experience               0.0003491 ***
Staff Satisfaction-Guest Dining Experience                         0.0056165 **
Sustainability of Guest Food Choices-Guest Dining Experience       0.0056165 **



```{r}
decision_maker_selection_probability_plot <- decision_maker_priority_probability_table %>%
  ggplot(aes(x=fct_reorder(indicator,probability,.fun="mean"),y=probability,fill=fct_reorder(indicator,probability,.fun="mean"),color=fct_reorder(indicator,probability,.fun="mean"))) +
  geom_violin(color="black",draw_quantiles=0.5,alpha=0.6,size=0.2,adjust=1) +
  geom_hline(yintercept=0.4866071,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Guest Dining Experience")),color="black",size=0.25,annotation="**",y_position=0.13,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=0.15,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Institutional Sustainability","Guest Dining Experience")),color="black",size=0.25,annotation="***",y_position=0.17,tip_length=-0.02,vjust=2.8) +
   geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="***",y_position=0.19,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Sustainability of Guest Food Choices","Guest Dining Experience")),color="black",size=0.25,annotation="**",y_position=0.21,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Dietary Health","Campus Culture")),color="black",size=0.25,annotation="*",y_position=0.81,tip_length=0.02,vjust=0.6) +
  geom_signif(comparisons=list(c("Operating Costs","Campus Culture")),color="black",size=0.25,annotation="*",y_position=0.79,tip_length=0.02,vjust=0.6) +
  stat_summary(fun.y=mean,geom="point",shape=19,size=1.75,color="black",fill="black") +
  stat_summary(data=priority_probability_table,fun.y=mean,geom="point",shape=4,size=1.75,color="black") +
  scale_fill_viridis_d(option="mako",limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  scale_color_viridis_d(option="mako",alpha=1) +
  scale_y_continuous(breaks=c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9),limits=c(0.15,0.85)) +
  scale_x_discrete(limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  xlab("") + 
  ylab("Selection Probability") + 
  labs(caption="F-value: 7.04 (3sf); p-value < 0.001",subtitle="Decision Makers (n=12)") + 
  coord_flip() +
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10),plot.subtitle=element_text(size=10,hjust=1),plot.caption=element_text(size=8),axis.title=element_text(size=10),axis.text=element_text(size=8))
decision_maker_selection_probability_plot
```
geom_jitter(width=0.33,size=2,shape=21,alpha=0.5) +

 stat_summary(data=technical_advisor_priority_probability_table,fun.y=mean,geom="point",shape=1,size=1.75,color="black") +

```{r}
technical_advisor_priority_score_frequencies <- tibble(comparison_indicator=c("Guest Dining Experience","Dietary Health","Operating Costs","Sustainability of Guest Food Choices","Food Pricing","Institutional Sustainability","Campus Culture","Staff Satisfaction"),guest_dining_experience_selection_frequency=as.double(NA),dietary_health_selection_frequency=as.double(NA),operating_costs_selection_frequency=as.double(NA),dietary_sustainability_selection_frequency=as.double(NA),food_pricing_selection_frequency=as.double(NA),institutional_sustainability_selection_frequency=as.double(NA),campus_culture_selection_frequency=as.double(NA),staff_satisfaction_selection_frequency=as.double(NA))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_priority_score_tabulation <- survey_data %>%
  filter(role=="Advisor") %>%
  select(id,dietary_health_ranking,dietary_sustainability_ranking,institutional_sustainability_ranking,food_pricing_ranking,operating_costs_ranking,guest_experience_ranking,staff_satisfaction_ranking,campus_culture_ranking)
technical_advisor_priority_score_tabulation
```

```{r}
technical_advisor_guest_experience_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(guest_experience_over_guest_experience=0) %>%
  mutate(guest_experience_over_dietary_health=case_when(guest_experience_ranking<dietary_health_ranking~1,
                                                        guest_experience_ranking>dietary_health_ranking~0)) %>%
  mutate(guest_experience_over_operating_costs=case_when(guest_experience_ranking<operating_costs_ranking~1,
                                                        guest_experience_ranking>operating_costs_ranking~0)) %>%
  mutate(guest_experience_over_dietary_sustainability=case_when(guest_experience_ranking<dietary_sustainability_ranking~1,
                                                        guest_experience_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_food_pricing=case_when(guest_experience_ranking<food_pricing_ranking~1,
                                                        guest_experience_ranking>food_pricing_ranking~0)) %>%
   mutate(guest_experience_over_institutional_sustainability=case_when(guest_experience_ranking<institutional_sustainability_ranking~1,
                                                        guest_experience_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(guest_experience_over_campus_culture=case_when(guest_experience_ranking<campus_culture_ranking~1,
                                                        guest_experience_ranking>campus_culture_ranking~0)) %>%
  mutate(guest_experience_over_staff_satisfaction=case_when(guest_experience_ranking<staff_satisfaction_ranking~1,
                                                        guest_experience_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,guest_experience_over_dietary_health,guest_experience_over_operating_costs,guest_experience_over_dietary_sustainability,guest_experience_over_food_pricing,guest_experience_over_institutional_sustainability,guest_experience_over_campus_culture,guest_experience_over_staff_satisfaction,guest_experience_over_guest_experience) %>%
  pivot_longer(!id,names_to="condition",values_to="frequency") %>%
  group_by(condition) %>%
  summarise(instances=sum(frequency))
technical_advisor_guest_experience_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_frequency=c(0,10,12,13,12,13,13,14))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_dietary_health_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(dietary_health_over_guest_experience=case_when(dietary_health_ranking<guest_experience_ranking~1,
                                                        dietary_health_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_health_over_dietary_health=0) %>%
  mutate(dietary_health_over_operating_costs=case_when(dietary_health_ranking<operating_costs_ranking~1,
                                                        dietary_health_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_health_over_dietary_sustainability=case_when(dietary_health_ranking<dietary_sustainability_ranking~1,
                                                        dietary_health_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_food_pricing=case_when(dietary_health_ranking<food_pricing_ranking~1,
                                                        dietary_health_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_health_over_institutional_sustainability=case_when(dietary_health_ranking<institutional_sustainability_ranking~1,
                                                        dietary_health_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_health_over_campus_culture=case_when(dietary_health_ranking<campus_culture_ranking~1,
                                                        dietary_health_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_health_over_staff_satisfaction=case_when(dietary_health_ranking<staff_satisfaction_ranking~1,
                                                        dietary_health_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_health_over_guest_experience,dietary_health_over_dietary_health,dietary_health_over_operating_costs,dietary_health_over_dietary_sustainability,dietary_health_over_food_pricing,dietary_health_over_institutional_sustainability,dietary_health_over_campus_culture,dietary_health_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_dietary_health_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(dietary_health_selection_frequency=c(7,0,9,13,10,11,11,13))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_operating_costs_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(operating_costs_over_guest_experience=case_when(operating_costs_ranking<guest_experience_ranking~1,
                                                        operating_costs_ranking>guest_experience_ranking~0)) %>%
  mutate(operating_costs_over_dietary_health=case_when(operating_costs_ranking<dietary_health_ranking~1,
                                                        operating_costs_ranking>dietary_health_ranking~0)) %>%
  mutate(operating_costs_over_operating_costs=0) %>%
  mutate(operating_costs_over_dietary_sustainability=case_when(operating_costs_ranking<dietary_sustainability_ranking~1,
                                                        operating_costs_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_food_pricing=case_when(operating_costs_ranking<food_pricing_ranking~1,
                                                        operating_costs_ranking>food_pricing_ranking~0)) %>%
  mutate(operating_costs_over_institutional_sustainability=case_when(operating_costs_ranking<institutional_sustainability_ranking~1,
                                                        operating_costs_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(operating_costs_over_campus_culture=case_when(operating_costs_ranking<campus_culture_ranking~1,
                                                        operating_costs_ranking>campus_culture_ranking~0)) %>%
  mutate(operating_costs_over_staff_satisfaction=case_when(operating_costs_ranking<staff_satisfaction_ranking~1,
                                                        operating_costs_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,operating_costs_over_guest_experience,operating_costs_over_dietary_health,operating_costs_over_operating_costs,operating_costs_over_dietary_sustainability,operating_costs_over_food_pricing,operating_costs_over_institutional_sustainability,operating_costs_over_campus_culture,operating_costs_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_operating_costs_priority_score_tabulation
```


```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(operating_costs_selection_frequency=c(5,8,0,8,12,12,11,13))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_dietary_sustainability_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(dietary_sustainability_over_guest_experience=case_when(dietary_sustainability_ranking<guest_experience_ranking~1,
                                                        dietary_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_health=case_when(dietary_sustainability_ranking<dietary_health_ranking~1,
                                                        dietary_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(dietary_sustainability_over_operating_costs=case_when(dietary_sustainability_ranking<operating_costs_ranking~1,
                                                        dietary_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(dietary_sustainability_over_dietary_sustainability=0) %>%
  mutate(dietary_sustainability_over_food_pricing=case_when(dietary_sustainability_ranking<food_pricing_ranking~1,
                                                        dietary_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(dietary_sustainability_over_institutional_sustainability=case_when(dietary_sustainability_ranking<institutional_sustainability_ranking~1,
                                                        dietary_sustainability_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(dietary_sustainability_over_campus_culture=case_when(dietary_sustainability_ranking<campus_culture_ranking~1,
                                                        dietary_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(dietary_sustainability_over_staff_satisfaction=case_when(dietary_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        dietary_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,dietary_sustainability_over_guest_experience,dietary_sustainability_over_dietary_health,dietary_sustainability_over_operating_costs,dietary_sustainability_over_dietary_sustainability,dietary_sustainability_over_food_pricing,dietary_sustainability_over_institutional_sustainability,dietary_sustainability_over_campus_culture,dietary_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_dietary_sustainability_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(dietary_sustainability_selection_frequency=c(4,4,9,0,12,8,11,13))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_food_pricing_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(food_pricing_over_guest_experience=case_when(food_pricing_ranking<guest_experience_ranking~1,
                                                        food_pricing_ranking>guest_experience_ranking~0)) %>%
  mutate(food_pricing_over_dietary_health=case_when(food_pricing_ranking<dietary_health_ranking~1,
                                                        food_pricing_ranking>dietary_health_ranking~0)) %>%
  mutate(food_pricing_over_operating_costs=case_when(food_pricing_ranking<operating_costs_ranking~1,
                                                        food_pricing_ranking>operating_costs_ranking~0)) %>%
  mutate(food_pricing_over_dietary_sustainability=case_when(food_pricing_ranking<dietary_sustainability_ranking~1,
                                                        food_pricing_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_food_pricing=0) %>%
  mutate(food_pricing_over_institutional_sustainability=case_when(food_pricing_ranking<institutional_sustainability_ranking~1,
                                                        food_pricing_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(food_pricing_over_campus_culture=case_when(food_pricing_ranking<campus_culture_ranking~1,
                                                        food_pricing_ranking>campus_culture_ranking~0)) %>%
  mutate(food_pricing_over_staff_satisfaction=case_when(food_pricing_ranking<staff_satisfaction_ranking~1,
                                                        food_pricing_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,food_pricing_over_guest_experience,food_pricing_over_dietary_health,food_pricing_over_operating_costs,food_pricing_over_dietary_sustainability,food_pricing_over_food_pricing,food_pricing_over_institutional_sustainability,food_pricing_over_campus_culture,food_pricing_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_food_pricing_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(food_pricing_selection_frequency=c(5,7,5,5,0,8,8,11))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_institutional_sustainability_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(institutional_sustainability_over_guest_experience=case_when(institutional_sustainability_ranking<guest_experience_ranking~1,
                                                        institutional_sustainability_ranking>guest_experience_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_health=case_when(institutional_sustainability_ranking<dietary_health_ranking~1,
                                                        institutional_sustainability_ranking>dietary_health_ranking~0)) %>%
  mutate(institutional_sustainability_over_operating_costs=case_when(institutional_sustainability_ranking<operating_costs_ranking~1,
                                                        institutional_sustainability_ranking>operating_costs_ranking~0)) %>%
  mutate(institutional_sustainability_over_dietary_sustainability=case_when(institutional_sustainability_ranking<dietary_sustainability_ranking~1,
                                                        institutional_sustainability_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(institutional_sustainability_over_food_pricing=case_when(institutional_sustainability_ranking<food_pricing_ranking~1,
                                                        institutional_sustainability_ranking>food_pricing_ranking~0)) %>%
  mutate(institutional_sustainability_over_institutional_sustainability=0) %>%
  mutate(institutional_sustainability_over_campus_culture=case_when(institutional_sustainability_ranking<campus_culture_ranking~1,
                                                        institutional_sustainability_ranking>campus_culture_ranking~0)) %>%
  mutate(institutional_sustainability_over_staff_satisfaction=case_when(institutional_sustainability_ranking<staff_satisfaction_ranking~1,
                                                        institutional_sustainability_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,institutional_sustainability_over_guest_experience,institutional_sustainability_over_dietary_health,institutional_sustainability_over_operating_costs,institutional_sustainability_over_dietary_sustainability,institutional_sustainability_over_food_pricing,institutional_sustainability_over_institutional_sustainability,institutional_sustainability_over_campus_culture,institutional_sustainability_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_institutional_sustainability_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(institutional_sustainability_selection_frequency=c(4,6,5,9,9,0,8,9))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_campus_culture_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(campus_culture_over_guest_experience=case_when(campus_culture_ranking<guest_experience_ranking~1,
                                                        campus_culture_ranking>guest_experience_ranking~0)) %>%
  mutate(campus_culture_over_dietary_health=case_when(campus_culture_ranking<dietary_health_ranking~1,
                                                        campus_culture_ranking>dietary_health_ranking~0)) %>%
  mutate(campus_culture_over_operating_costs=case_when(campus_culture_ranking<operating_costs_ranking~1,
                                                        campus_culture_ranking>operating_costs_ranking~0)) %>%
  mutate(campus_culture_over_dietary_sustainability=case_when(campus_culture_ranking<dietary_sustainability_ranking~1,
                                                        campus_culture_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_food_pricing=case_when(campus_culture_ranking<food_pricing_ranking~1,
                                                        campus_culture_ranking>food_pricing_ranking~0)) %>%
  mutate(campus_culture_over_institutional_sustainability=case_when(campus_culture_ranking<institutional_sustainability_ranking~1,
                                                        campus_culture_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(campus_culture_over_campus_culture=0) %>%
  mutate(campus_culture_over_staff_satisfaction=case_when(campus_culture_ranking<staff_satisfaction_ranking~1,
                                                        campus_culture_ranking>staff_satisfaction_ranking~0)) %>%
  select(id,campus_culture_over_guest_experience,campus_culture_over_dietary_health,campus_culture_over_operating_costs,campus_culture_over_dietary_sustainability,campus_culture_over_food_pricing,campus_culture_over_institutional_sustainability,campus_culture_over_campus_culture,campus_culture_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_campus_culture_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(campus_culture_selection_frequency=c(4,6,6,6,9,9,0,10))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_staff_satisfaction_priority_score_tabulation <- technical_advisor_priority_score_tabulation %>%
  mutate(staff_satisfaction_over_guest_experience=case_when(staff_satisfaction_ranking<guest_experience_ranking~1,
                                                        staff_satisfaction_ranking>guest_experience_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_health=case_when(staff_satisfaction_ranking<dietary_health_ranking~1,
                                                        staff_satisfaction_ranking>dietary_health_ranking~0)) %>%
  mutate(staff_satisfaction_over_operating_costs=case_when(staff_satisfaction_ranking<operating_costs_ranking~1,
                                                        staff_satisfaction_ranking>operating_costs_ranking~0)) %>%
  mutate(staff_satisfaction_over_dietary_sustainability=case_when(staff_satisfaction_ranking<dietary_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>dietary_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_food_pricing=case_when(staff_satisfaction_ranking<food_pricing_ranking~1,
                                                        staff_satisfaction_ranking>food_pricing_ranking~0)) %>%
  mutate(staff_satisfaction_over_institutional_sustainability=case_when(staff_satisfaction_ranking<institutional_sustainability_ranking~1,
                                                        staff_satisfaction_ranking>institutional_sustainability_ranking~0)) %>%
  mutate(staff_satisfaction_over_campus_culture=case_when(staff_satisfaction_ranking<campus_culture_ranking~1,
                                                        staff_satisfaction_ranking>campus_culture_ranking~0)) %>%
  mutate(staff_satisfaction_over_staff_satisfaction=0) %>%
  select(id,staff_satisfaction_over_guest_experience,staff_satisfaction_over_dietary_health,staff_satisfaction_over_operating_costs,staff_satisfaction_over_dietary_sustainability,staff_satisfaction_over_food_pricing,staff_satisfaction_over_institutional_sustainability,staff_satisfaction_over_campus_culture,staff_satisfaction_over_staff_satisfaction) %>%
  pivot_longer(!id,names_to="condition",values_to="instances") %>%
  group_by(condition) %>%
  summarise(instances=sum(instances))
technical_advisor_staff_satisfaction_priority_score_tabulation
```

```{r}
technical_advisor_priority_score_frequencies <- technical_advisor_priority_score_frequencies %>%
  mutate(staff_satisfaction_selection_frequency=c(3,4,4,4,6,8,7,0))
technical_advisor_priority_score_frequencies
```

```{r}
technical_advisor_priority_score_probabilities <- technical_advisor_priority_score_frequencies %>%
  mutate(guest_dining_experience_selection_probability=guest_dining_experience_selection_frequency/17,.after=guest_dining_experience_selection_frequency) %>%
  mutate(dietary_health_selection_probability=dietary_health_selection_frequency/17,.after=dietary_health_selection_frequency) %>%
  mutate(operating_costs_selection_probability=operating_costs_selection_frequency/17,.after=operating_costs_selection_frequency) %>%
   mutate(dietary_sustainability_selection_probability=dietary_sustainability_selection_frequency/17,.after=dietary_sustainability_selection_frequency) %>%
  mutate(food_pricing_selection_probability=food_pricing_selection_frequency/17,.after=food_pricing_selection_frequency) %>%
  mutate(institutional_sustainability_selection_probability=institutional_sustainability_selection_frequency/17,.after=institutional_sustainability_selection_frequency) %>%
  mutate(campus_culture_selection_probability=campus_culture_selection_frequency/17,.after=campus_culture_selection_frequency) %>%
   mutate(staff_satisfaction_selection_probability=staff_satisfaction_selection_frequency/17,.after=staff_satisfaction_selection_frequency)
technical_advisor_priority_score_probabilities
```

```{r}
technical_advisor_priority_probability_table <- technical_advisor_priority_score_probabilities %>%
  select(comparison_indicator,guest_dining_experience_selection_probability,dietary_health_selection_probability,operating_costs_selection_probability,dietary_sustainability_selection_probability,food_pricing_selection_probability,institutional_sustainability_selection_probability,campus_culture_selection_probability,staff_satisfaction_selection_probability) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="probability") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_probability","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_probability","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_probability","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_probability","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_probability","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_probability","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_probability","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_probability","Staff Satisfaction")) %>%
  filter(probability>0)
technical_advisor_priority_probability_table
```

```{r}
technical_advisor_priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability))
```

```{r}
technical_advisor_priority_probability_table %>%
  group_by(indicator) %>%
  summarise(total_selection_probability=sum(probability),mean_selection_probability=mean(probability)) %>%
  arrange(desc(mean_selection_probability)) %>%
  summarise(mean=mean(mean_selection_probability))
```

```{r}
technical_advisor_selection_probability_aov <- aov(probability~indicator,data=technical_advisor_priority_probability_table)
summary(technical_advisor_selection_probability_aov)
```

```{r}
TukeyHSD(technical_advisor_selection_probability_aov)
```

Guest Dining Experience-Campus Culture                            0.0032856 **
Guest Dining Experience-Food Pricing                              0.0023267 **
Institutional Sustainability-Guest Dining Experience              0.0032856 **
Staff Satisfaction-Guest Dining Experience                        0.0000188 ***
Staff Satisfaction-Dietary Health                                 0.0023267 **
Staff Satisfaction-Operating Costs                                0.0123439 *

```{r}
technical_advisor_selection_probability_plot <- technical_advisor_priority_probability_table %>%
  ggplot(aes(x=fct_reorder(indicator,probability,.fun="mean"),y=probability,fill=fct_reorder(indicator,probability,.fun="mean"),color=fct_reorder(indicator,probability,.fun="mean"))) +
  geom_violin(color="black",draw_quantiles=0.5,alpha=0.6,size=0.2,adjust=1) +
  geom_hline(yintercept=0.5,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=0.13,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Campus Culture")),color="black",size=0.25,annotation="**",y_position=0.15,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Institutional Sustainability")),color="black",size=0.25,annotation="**",y_position=0.17,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Guest Dining Experience","Food Pricing")),color="black",size=0.25,annotation="**",y_position=0.19,tip_length=-0.02,vjust=2.8) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Operating Costs")),color="black",size=0.25,annotation="*",y_position=0.79,tip_length=0.02,vjust=0.6) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Dietary Health")),color="black",size=0.25,annotation="**",y_position=0.81,tip_length=0.02,vjust=0.6) +
  stat_summary(fun.y=mean,geom="point",shape=1,size=1.75,color="black") +
  stat_summary(data=priority_probability_table,fun.y=mean,geom="point",shape=4,size=1.75,color="black") +
  stat_summary(data=decision_maker_priority_probability_table,fun.y=mean,geom="point",shape=19,size=1.75,color="black",fill="black") +
  scale_fill_viridis_d(option="mako",limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  scale_color_viridis_d(option="mako",alpha=1) +
  scale_y_continuous(breaks=c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9),limits=c(0.15,0.85)) +
  scale_x_discrete(limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  xlab("") + 
  ylab("Selection Probability") + 
  labs(caption="F-value: 6.79 (3sf); p-value < 0.001",subtitle="Advisors (n=17)") + 
  coord_flip() +
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10),plot.subtitle=element_text(size=10,hjust=1),plot.caption=element_text(size=8),axis.title=element_text(size=10),axis.text=element_text(size=8))
technical_advisor_selection_probability_plot
```
geom_jitter(width=0.6,size=2,shape=21,alpha=0.5) +

```{r}
decomposed_selection_probability_distribution_plots <- ggarrange(decision_maker_selection_probability_plot,technical_advisor_selection_probability_plot,
          ncol=2,
          labels=c("B","C"))
```

```{r}
selection_probability_distribution_plots <- ggarrange(selection_probability_plot,decision_maker_selection_probability_plot,technical_advisor_selection_probability_plot,
                                                      labels=c("A","B","C"),
                                                      nrow=3)
ggsave(filename="selection_probability_distributions.png",plot=selection_probability_distribution_plots,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=20,height=30,units="cm",dpi=150,limitsize=TRUE)
selection_probability_distribution_plots
```


could use geom_jitter more strategically to highlight asymmetries in stakeholder/role types

build in legend calling out overall mean and subgroup mean

independent groups t-test 

Dietary Health

```{r}
guest_dining_experience_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Guest Dining Experience") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
guest_dining_experience_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Guest Dining Experience") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(guest_dining_experience_decision_maker_probabilities,guest_dining_experience_technical_advisor_probabilities)
```

```{r}
dietary_health_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Dietary Health") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
dietary_health_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Dietary Health") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(dietary_health_decision_maker_probabilities,dietary_health_technical_advisor_probabilities)
```

```{r}
operating_costs_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Operating Costs") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
operating_costs_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Operating Costs") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(operating_costs_decision_maker_probabilities,operating_costs_technical_advisor_probabilities)
```

```{r}
dietary_sustainability_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Sustainability of Guest Food Choices") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
dietary_sustainability_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Sustainability of Guest Food Choices") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(dietary_sustainability_decision_maker_probabilities,dietary_sustainability_technical_advisor_probabilities)
```

```{r}
food_pricing_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Food Pricing") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
food_pricing_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Food Pricing") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(food_pricing_decision_maker_probabilities,food_pricing_technical_advisor_probabilities)
```

```{r}
institutional_sustainability_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Institutional Sustainability") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
institutional_sustainability_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Institutional Sustainability") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(institutional_sustainability_decision_maker_probabilities,institutional_sustainability_technical_advisor_probabilities)
```

```{r}
campus_culture_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Campus Culture") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
campus_culture_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Campus Culture") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(campus_culture_decision_maker_probabilities,campus_culture_technical_advisor_probabilities)
```

```{r}
staff_satisfaction_decision_maker_probabilities <- decision_maker_priority_probability_table %>%
  filter(indicator=="Staff Satisfaction") %>%
  mutate(subgroup="Decision Maker",.before=probability) %>%
  select(probability)
staff_satisfaction_technical_advisor_probabilities <- technical_advisor_priority_probability_table %>%
  filter(indicator=="Staff Satisfaction") %>%
  mutate(subgroup="Advisor",.before=probability) %>%
  select(probability)
t.test(staff_satisfaction_decision_maker_probabilities,staff_satisfaction_technical_advisor_probabilities)
```

STAFF SATISFACTION SIGNIF DIFF (*)


 welch because assume unequal variance n<30
 
 
 
 ## Joint Correlation Analysis
 
```{r}
joint_correlation_appearance_likelihood <- api_frequencies_manual %>%
  mutate(appearance_likelihood=frequency_manual/116) %>%
  select(accessory_indicator_var_manual,appearance_likelihood) %>%
  rename(indicator=accessory_indicator_var_manual)
joint_correlation_selection_probabilities <- priority_probability_table %>%
  group_by(indicator) %>%
  summarise(selection_probability=mean(probability)) %>%
  arrange(desc(selection_probability))
joint_correlation_table <- left_join(joint_correlation_appearance_likelihood,joint_correlation_selection_probabilities,by=join_by(indicator))
```



```{r}
joint_correlation_table
```

 
```{r}
joint_correlation_plot <- joint_correlation_table %>%
  ggplot(aes(x=selection_probability,y=appearance_likelihood,color=indicator)) +
  geom_smooth(method=lm,se=FALSE,color="black",linewidth=0.25) +
  geom_point() + 
  geom_text(aes(label=indicator),hjust=0,nudge_x=0.01,size=2.5) + 
  scale_x_continuous(limits=c(0,0.85)) + 
  scale_y_continuous(limits=c(0,0.85)) +
  scale_color_viridis_d(option="mako",limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Operating Costs","Dietary Health","Guest Dining Experience")) +
  xlab("Selection Probability") + 
  ylab("Appearance Likelihood") +
  labs(caption="Adjusted R-Squared: -0.114 (3sf); p-value = 0.612 (3sf)") + 
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10),plot.subtitle=element_text(size=10,hjust=1),plot.caption=element_text(size=8),axis.title=element_text(size=10),axis.text=element_text(size=8))
ggsave(filename="joint_correlation_plot.png",plot=joint_correlation_plot,path="/Users/kenjinchang/github/stakeholder-analysis/figures",width=20,height=20,units="cm",dpi=150,limitsize=TRUE)
joint_correlation_plot
```

```{r}
joint_correlation_lm <- lm(appearance_likelihood~selection_probability,data=joint_correlation_table)
summary(joint_correlation_lm)
```

 Re run to see what happens when you limit joint correlation analysis to those with significant differences only
 

```{r}
campus_culture_limited_joint_correlation_table <- joint_correlation_table %>%
  filter(!indicator=="Dietary Health") %>%
  filter(!indicator=="Operating Costs") 
```

```{r}
campus_culture_limited_joint_correlation_table %>%
  ggplot(aes(x=selection_probability,y=appearance_likelihood,color=indicator)) +
  geom_smooth(method=lm,se=FALSE,color="black",linewidth=0.25) +
  geom_point() + 
  geom_text(aes(label=indicator),hjust=0,nudge_x=0.01,size=2.5) + 
  scale_x_continuous(limits=c(0,0.85)) + 
  scale_y_continuous(limits=c(0,0.85)) +
  scale_color_viridis_d(option="mako",limits=c("Staff Satisfaction","Campus Culture","Institutional Sustainability","Food Pricing","Sustainability of Guest Food Choices","Guest Dining Experience")) +
  xlab("Selection Probability") + 
  ylab("Appearance Likelihood") +
  labs(caption="Adjusted R-Squared: -0.114 (3sf); p-value = 0.612 (3sf)") + 
  theme(legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10),plot.subtitle=element_text(size=10,hjust=1),plot.caption=element_text(size=8),axis.title=element_text(size=10),axis.text=element_text(size=8))
```

```{r}
campus_culture_limited_joint_correlation_lm <- lm(appearance_likelihood~selection_probability,data=campus_culture_limited_joint_correlation_table)
summary(campus_culture_limited_joint_correlation_lm)
```


















```{r}
priority_z_score_table <- priority_score_zscores %>%
  select(comparison_indicator,guest_dining_experience_selection_zscore,dietary_health_selection_zscore,operating_costs_selection_zscore,dietary_sustainability_selection_zscore,food_pricing_selection_zscore,institutional_sustainability_selection_zscore,campus_culture_selection_zscore,staff_satisfaction_selection_zscore) %>%
  pivot_longer(!comparison_indicator,names_to="indicator",values_to="z_score") %>%
  select(-comparison_indicator) %>%
  mutate(across(indicator,str_replace,"guest_dining_experience_selection_zscore","Guest Dining Experience")) %>%
  mutate(across(indicator,str_replace,"dietary_health_selection_zscore","Dietary Health")) %>%
  mutate(across(indicator,str_replace,"operating_costs_selection_zscore","Operating Costs")) %>%
  mutate(across(indicator,str_replace,"dietary_sustainability_selection_zscore","Sustainability of Guest Food Choices")) %>%
  mutate(across(indicator,str_replace,"food_pricing_selection_zscore","Food Pricing")) %>%
  mutate(across(indicator,str_replace,"institutional_sustainability_selection_zscore","Institutional Sustainability")) %>%
  mutate(across(indicator,str_replace,"campus_culture_selection_zscore","Campus Culture")) %>%
  mutate(across(indicator,str_replace,"staff_satisfaction_selection_zscore","Staff Satisfaction")) %>%
  filter(z_score>0)
priority_z_score_table
```

NEED TO FIGURE OUT IF FILTERING OUT ZERO VALUES IN THIS CASE IS APPROPRIATE FOR THURSTONE'S LAW COMPARISONS

```{r}
priority_z_score_table %>%
  group_by(indicator) %>%
  summarise(total_selection_z_score=sum(z_score),mean_selection_z_score=mean(z_score)) %>%
  arrange(desc(mean_selection_z_score))
```


```{r}
priority_z_score_table %>%
  ggplot(aes(x=fct_reorder(indicator,z_score,.fun="mean"),y=z_score,fill=fct_reorder(indicator,z_score,.fun="mean"),color=fct_reorder(indicator,z_score,.fun="mean"))) +
  geom_boxplot(outlier.shape=NA,color="black",size=0.25,alpha=0.8) +
  stat_summary(fun.y=mean,geom="point",shape=20,size=2,color="black",fill="white") +
  scale_fill_viridis_d(option="mako") +
  scale_color_viridis_d(option="mako",alpha=1) +
  xlab("") + 
  ylab("Z-Score") + 
  labs(caption="F-value: tbd (3sf); p-value = tbd") + 
  coord_flip() +
  theme(aspect.ratio=0.8,legend.position="none",panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```







