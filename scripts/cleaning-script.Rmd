---
title: "Cleaning Script"
output: github_document
date: "Last Updated: February 11, 2025"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Package Loading

```{r}
library(tidyverse)
library(ggpubr)
library(ggsignif)
library(maps)
```

## Data Loading 

```{r}
survey_data <- read.csv("/Users/kenjinchang/github/stakeholder-analysis/data/parent-files/survey-data.csv")
extraction_data <-read.csv("/Users/kenjinchang/github/stakeholder-analysis/data/parent-files/extraction-data.csv")
```

## Data Cleaning: Scoping Review

Below, we list, operationalize, and—where applicable—provide the input range for each of the 42 originally extracted variables:

* `study_id`: the unique numeral identifier assigned to each independently eligible study included within our scoping review (1-116).
* `study`: the parenthetical, in-text citation for each independently eligible study's corresponding record of reference. 
* `study_no`: the assigned number specifying the order in which the independently eligible study appears within the corresponding record of reference.
* `study_count`: the total number of independently eligible studies appearing within the corresponding record of reference.
* `doi`: the handle, or digital object identifier (DOI), assigned to each independently eligible study's corresponding record of reference.
* `pub_year`: the calendar year when each independently eligible study's corresponding record of reference was published (2001-2024).
* `pub_title`: the given title for each independently eligible study's corresponding record of reference.
* `pub_journal`: the publishing journal of each independently eligible study's record of reference.
* `university_list`: the complete list of treatment-receiving universities participating in the independently eligible study.
* `university_count`: the total number of treatment-receiving universities participating in the independently eligible study.
* `investigation_cat`: the scale of the independently eligible study's investigation (single-site for study's localized to one treatment-receiving university or multi-site for study's implemented across multiple treatment-receiving universities).
* `nation_list`: a duplicate-allowing list pairing the ISO (International Organization for Standardization) country associated with each participating treatment-receiving university.
* `nation_list_count`: the total number of countries listed.
* `nation_var`:
* `nation_var_count`:
* `us_state_list`:
* `us_state_list_count`:
* `us_state_var`:
* `us_state_var_count`:
* `uk_country`:
* `strategy_list`:
* `approach_cat`:
* `target_list`:
* `breadth_cat`:
* `design`:
* `principal_indicator_list`:
* `principal_indicator_list_count`:
* `principal_indicator_var`:
* `principal_indicator_var_count`:
* `accessory_indicator_list`:
* `accessory_indicator_list_count`:
* `accessory_indicator_var`:
* `accessory_indicator_var_count`:
* `qualifying_indicator_list`:
* `qualifying_indicator_list_count`:
* `qualifying_indicator_var`:
* `qualifying_indicator_var_count`:
* `spillover_monitoring_list`:
* `spillover_monitoring_list_count`:
* `spillover_monitoring_var`:
* `spillover_monitoring_var_count`:
* `intention_behavior_monitoring`:

### Time

```{r}
temporal_frequencies <- extraction_data %>%
  select(pub_year,university_count) %>%
  drop_na() %>%
  mutate(count=case_when(university_count>=1~1)) %>%
  group_by(pub_year) %>%
  summarise(frequency=sum(count)) %>%
  mutate(cumulative_frequency=cumsum(frequency)) %>%
  add_row(pub_year=2000,frequency=0) %>%
  add_row(pub_year=2002,frequency=0) %>%
  add_row(pub_year=2003,frequency=0) %>%
  add_row(pub_year=2004,frequency=0) %>%
  add_row(pub_year=2007,frequency=0) %>%
  add_row(pub_year=2008,frequency=0) %>%
  add_row(pub_year=2010,frequency=0) %>%
  arrange(pub_year) %>%
  mutate(cumulative_frequency=cumsum(frequency)) 
temporal_frequencies
```

```{r}
exponential_fit <- temporal_frequencies %>%
  slice(-1)
exponential_model <- lm(log(cumulative_frequency)~pub_year,data=exponential_fit)
summary(exponential_model)
```

```{r}
temporal_frequencies_plot <- temporal_frequencies %>%
  ggplot(aes(x=pub_year,y=frequency,color=frequency,fill=frequency)) + 
  geom_col() +
  scale_fill_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  scale_color_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  xlab("Publication Year") + 
  ylab("Frequency") + 
  ylim(0,115) +
  labs(caption="   ") + 
  theme(legend.position="none",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
temporal_cumulative_frequencies_plot <- temporal_frequencies %>%
  ggplot(aes(x=pub_year,y=cumulative_frequency,color=cumulative_frequency,fill=cumulative_frequency)) +
  scale_fill_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  scale_color_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  geom_col() + 
  xlab("Publication Year") + 
  ylab("Cumulative Frequency") + 
  labs(caption="Adjusted R-Squared: 0.985 (3sf)") + 
  theme(legend.title.position="none",legend.position="none",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.width=unit(50,"pt"),legend.key.height=unit(7.5,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
ggarrange(temporal_frequencies_plot,temporal_cumulative_frequencies_plot,
          nrow=2,
          labels=c("A","B"))
```

### Place

```{r}
global_shapefile <- map_data("world")
global_shapefile <- global_shapefile %>% 
  rename(country=region) %>%
  mutate(country=case_when(country=="Macedonia"~"North Macedonia",
                           country=="Ivory Coast"~"Cote d'Ivoire",
                           country=="Democratic Republic of the Congo"~"Congo, Dem. Rep.",
                           country=="Republic of Congo"~"Congo, Rep.",
                           country=="UK"~"United Kingdom",
                           country=="USA"~"United States",
                           country=="Laos"~"Lao",
                           country=="Slovakia"~"Slovak Republic",
                           country=="Saint Lucia"~"St. Lucia",
                           country=="Kyrgyzstan"~"Krygyz Republic",
                           country=="Micronesia"~"Micronesia, Fed. Sts.",
                           country=="Swaziland"~"Eswatini",
                           country=="Virgin Islands"~"Virgin Islands (U.S.)",
                        TRUE~country))
island_nations <- c("Antigua","Barbuda","Nevis", 
                 "Saint Kitts","Trinidad",
                 "Tobago","Grenadines","Saint Vincent")
island_nations_match <- global_shapefile %>% 
  filter(country %in% island_nations)
ant_bar <- c(137,138 )
kit_nev <- c(930,931)
tri_tog <- c(1425,1426)
vin_gre <- c(1575,1576,1577)
island_nation_names <- c("Antigua and Barbuda","St. Kitts and Nevis","Trinidad and Tobago","St. Vincent and the Grenadines")
island_nations_match <- island_nations_match %>% 
  mutate(country=case_when(group %in% ant_bar~"Antigua and Barbuda",
                           group %in% kit_nev~"St. Kitts and Nevis",
                           group %in% tri_tog~"Trinidad and Tobago",
                           group %in% vin_gre~"St. Vincent and the Grenadines")) %>% 
  tibble()
global_shapefile <- global_shapefile %>%
  filter(!country %in% island_nation_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(island_nations_match) %>%
  arrange(country) %>%
  tibble()
sra_names <- c("Hong Kong","Macao")
hk_mc <- global_shapefile %>% 
  filter(subregion %in% sra_names)
hk_mc <- hk_mc %>%
  mutate(country = case_when(subregion=="Hong Kong"~"Hong Kong, China",
                             subregion=="Macao"~"Macao, China"))
global_shapefile <- global_shapefile %>%
  filter(!subregion %in% sra_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(hk_mc) %>%
  select(-subregion) %>% 
  tibble()
```

```{r}
spatial_frequencies <- extraction_data %>%
  select(nation_var,university_count) %>%
  rename(country=nation_var) %>%
  mutate(across(country,str_replace,"USA","United States")) %>%
  mutate(across(country,str_replace,"UK","United Kingdom")) %>%
  group_by(country) %>%
  summarise(count=sum(university_count)) 
```

```{r}
spatial_frequencies %>%
  arrange(desc(count))
```

```{r}
spatial_frequencies_joined <- left_join(global_shapefile,spatial_frequencies,by="country")
national_frequencies <- spatial_frequencies_joined %>%
  ggplot(aes(x=long,y=lat,fill=count,group=group)) + 
  geom_polygon(color="black",linewidth=0.125,alpha=0.75) +
  scale_fill_gradient(low="lavender",high="slateblue4",na.value="white",name="Intervention-Receiving Institutions",guide=guide_colourbar(reverse=FALSE,alpha=0.75,title.position="top",title.hjust=0.5,limits=c(1,74))) +
  scale_y_continuous(limits=c(-60,90)) + 
  xlab("") + 
  ylab("") +
  labs(caption="") +
  theme(legend.key.width=unit(3,"lines"),legend.position="bottom",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
national_frequencies
```

### Primary Performance Indicators

### Accessory Performance Indicators

### Performance Qualifiers 

### Gap Monitoring

#### Spillover 

#### Intention-Behavior Asymmetries

variety

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Campus Culture")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Dietary Health")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Operating Costs")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Sustainability of Guest Food Choices")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Guest Dining Experience")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Food Pricing")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Institutional Sustainability")
```

```{r}
extraction_data %>%
  select(accessory_indicator_var) %>%
  str_count("Staff Satisfaction")
```

list

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Campus Culture")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Dietary Health")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Operating Costs")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Sustainability of Guest Food Choices")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Guest Dining Experience")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Food Pricing")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Institutional Sustainability")
```

```{r}
extraction_data %>%
  select(accessory_indicator_list) %>%
  str_count("Staff Satisfaction")
```

## Data Cleaning: Stakeholder Analysis


